{"type":"system","subtype":"init","cwd":"/Users/emmayu/crqbench/projects/thunderbird-android","session_id":"a3014417-ac1f-4d8f-9728-589140381065","tools":["Bash","Read","Edit"],"mcp_servers":[],"model":"claude-opus-4-20250514","permissionMode":"default","slash_commands":["keybindings-help","debug","compact","context","cost","init","pr-comments","release-notes","review","security-review","insights"],"apiKeySource":"/login managed key","claude_code_version":"2.1.32","output_style":"default","agents":["Bash","general-purpose","statusline-setup","Explore","Plan"],"skills":["keybindings-help","debug"],"plugins":[],"uuid":"bd01c8a4-b289-4e32-aa43-d7f9baf35ac6"}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_01CqTQpGm6fYPXiE4FuYxkzf","type":"message","role":"assistant","content":[{"type":"text","text":"I'll help you find and analyze the code at the end of `initializeFromLocalSearch` to see if it depends on `drawer`. Let me search for this method first."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":7819,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":7819,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"e8b678da-3a60-4900-9e0b-bf2f3d3870aa"}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_01CqTQpGm6fYPXiE4FuYxkzf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018MS6pPTmnoUaeSS1wqxdzL","name":"Bash","input":{"command":"find . -type f -name \"*.java\" -o -name \"*.kt\" | head -20","description":"Find Java and Kotlin files to understand the project structure"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":7819,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":7819,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"19ccfa26-68ba-43ae-a691-056a942387b2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018MS6pPTmnoUaeSS1wqxdzL","type":"tool_result","content":"./app/ui/src/test/java/org/openintents/openpgp/util/ShadowOpenPgpAsyncTask.java\n./app/ui/src/test/java/com/fsck/k9/ui/crypto/MessageCryptoHelperTest.java\n./app/ui/src/test/java/com/fsck/k9/activity/compose/RecipientLoaderTest.java\n./app/ui/src/test/java/com/fsck/k9/activity/compose/RecipientPresenterTest.java\n./app/ui/src/test/java/com/fsck/k9/activity/ActivityListenerTest.java\n./app/ui/src/test/java/com/fsck/k9/contacts/ContactLetterExtractorTest.kt\n./app/ui/src/test/java/com/fsck/k9/TestApp.kt\n./app/ui/src/test/java/com/fsck/k9/K9RobolectricTest.kt\n./app/ui/src/test/java/com/fsck/k9/RobolectricTest.kt\n./app/ui/src/test/java/com/fsck/k9/view/MessageHeaderTest.kt\n./app/ui/src/test/java/com/fsck/k9/account/AccountCreatorTest.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/MessageCryptoPresenter.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/MessageContainerView.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/MessageTopView.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/LockedAttachmentView.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/MessageViewFragment.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/AttachmentView.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/AttachmentController.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/DownloadImageTask.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/AttachmentViewCallback.java","is_error":false}]},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"3740dfd8-e7b1-47cb-a629-ad74e2df8176","tool_use_result":{"stdout":"./app/ui/src/test/java/org/openintents/openpgp/util/ShadowOpenPgpAsyncTask.java\n./app/ui/src/test/java/com/fsck/k9/ui/crypto/MessageCryptoHelperTest.java\n./app/ui/src/test/java/com/fsck/k9/activity/compose/RecipientLoaderTest.java\n./app/ui/src/test/java/com/fsck/k9/activity/compose/RecipientPresenterTest.java\n./app/ui/src/test/java/com/fsck/k9/activity/ActivityListenerTest.java\n./app/ui/src/test/java/com/fsck/k9/contacts/ContactLetterExtractorTest.kt\n./app/ui/src/test/java/com/fsck/k9/TestApp.kt\n./app/ui/src/test/java/com/fsck/k9/K9RobolectricTest.kt\n./app/ui/src/test/java/com/fsck/k9/RobolectricTest.kt\n./app/ui/src/test/java/com/fsck/k9/view/MessageHeaderTest.kt\n./app/ui/src/test/java/com/fsck/k9/account/AccountCreatorTest.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/MessageCryptoPresenter.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/MessageContainerView.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/MessageTopView.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/LockedAttachmentView.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/MessageViewFragment.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/AttachmentView.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/AttachmentController.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/DownloadImageTask.java\n./app/ui/src/main/java/com/fsck/k9/ui/messageview/AttachmentViewCallback.java","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_01U571Cog8QkZ4i86kM51pJh","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me search for the `initializeFromLocalSearch` method:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":761,"cache_read_input_tokens":7819,"cache_creation":{"ephemeral_5m_input_tokens":761,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"8acaddd5-d884-4cc5-9219-9da0bc61e0ab"}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_01U571Cog8QkZ4i86kM51pJh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019hP8yz2m7vGfFhLALh6BJS","name":"Bash","input":{"command":"grep -r \"initializeFromLocalSearch\" . --include=\"*.java\" --include=\"*.kt\" | head -20","description":"Search for initializeFromLocalSearch method across Java and Kotlin files"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":761,"cache_read_input_tokens":7819,"cache_creation":{"ephemeral_5m_input_tokens":761,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"f1a448ba-5dd7-4b28-9b82-167f4ebf1e2f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019hP8yz2m7vGfFhLALh6BJS","type":"tool_result","content":"./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:            initializeFromLocalSearch(messageListFragment.getLocalSearch());\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:        initializeFromLocalSearch(search);\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:        initializeFromLocalSearch(search);\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:        initializeFromLocalSearch(tmpSearch);\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:        initializeFromLocalSearch(tmpSearch);\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:    private void initializeFromLocalSearch(LocalSearch search) {","is_error":false}]},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"ff977f9b-3f57-4003-aed6-14ce5b27b32c","tool_use_result":{"stdout":"./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:            initializeFromLocalSearch(messageListFragment.getLocalSearch());\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:        initializeFromLocalSearch(search);\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:        initializeFromLocalSearch(search);\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:        initializeFromLocalSearch(tmpSearch);\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:        initializeFromLocalSearch(tmpSearch);\n./app/ui/src/main/java/com/fsck/k9/activity/MessageList.java:    private void initializeFromLocalSearch(LocalSearch search) {","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_01JV8xZ3ZhGrb7QA7UNNR1Ud","type":"message","role":"assistant","content":[{"type":"text","text":"Found it! Let me look at the `MessageList.java` file to see the `initializeFromLocalSearch` method:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":364,"cache_read_input_tokens":8580,"cache_creation":{"ephemeral_5m_input_tokens":364,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"5d26d00d-7478-4829-9442-8be92243fc52"}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_01JV8xZ3ZhGrb7QA7UNNR1Ud","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KcPDfrbxWUV3JSzS2aHdLU","name":"Read","input":{"file_path":"/Users/emmayu/crqbench/projects/thunderbird-android/app/ui/src/main/java/com/fsck/k9/activity/MessageList.java"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":364,"cache_read_input_tokens":8580,"cache_creation":{"ephemeral_5m_input_tokens":364,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"2c2d26c4-c54a-4ea7-80b3-042046da86e2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KcPDfrbxWUV3JSzS2aHdLU","type":"tool_result","content":"     1→package com.fsck.k9.activity;\n     2→\n     3→\n     4→import android.annotation.SuppressLint;\n     5→import android.app.SearchManager;\n     6→import android.arch.lifecycle.Observer;\n     7→import android.arch.lifecycle.ViewModelProvider;\n     8→import android.arch.lifecycle.ViewModelProviders;\n     9→import android.content.Context;\n    10→import android.content.Intent;\n    11→import android.content.IntentSender;\n    12→import android.content.IntentSender.SendIntentException;\n    13→import android.content.res.Configuration;\n    14→import android.net.Uri;\n    15→import android.os.Build;\n    16→import android.os.Bundle;\n    17→import android.os.Parcelable;\n    18→import android.support.annotation.Nullable;\n    19→import android.support.v4.app.FragmentManager;\n    20→import android.support.v4.app.FragmentManager.OnBackStackChangedListener;\n    21→import android.support.v4.app.FragmentTransaction;\n    22→import android.support.v4.widget.DrawerLayout;\n    23→import android.support.v7.app.ActionBar;\n    24→import android.support.v7.app.ActionBarDrawerToggle;\n    25→import android.view.KeyEvent;\n    26→import android.view.LayoutInflater;\n    27→import android.view.Menu;\n    28→import android.view.MenuItem;\n    29→import android.view.MotionEvent;\n    30→import android.view.View;\n    31→import android.view.ViewGroup;\n    32→import android.view.animation.AnimationUtils;\n    33→import android.widget.ProgressBar;\n    34→import android.widget.TextView;\n    35→import android.widget.Toast;\n    36→\n    37→import com.fsck.k9.Account;\n    38→import com.fsck.k9.Account.SortType;\n    39→import com.fsck.k9.DI;\n    40→import com.fsck.k9.K9;\n    41→import com.fsck.k9.K9.SplitViewMode;\n    42→import com.fsck.k9.Preferences;\n    43→import com.fsck.k9.activity.compose.MessageActions;\n    44→import com.fsck.k9.activity.misc.SwipeGestureDetector.OnSwipeGestureListener;\n    45→import com.fsck.k9.controller.MessageReference;\n    46→import com.fsck.k9.fragment.MessageListFragment;\n    47→import com.fsck.k9.fragment.MessageListFragment.MessageListFragmentListener;\n    48→import com.fsck.k9.helper.Contacts;\n    49→import com.fsck.k9.helper.ParcelableUtil;\n    50→import com.fsck.k9.mailstore.Folder;\n    51→import com.fsck.k9.mailstore.SearchStatusManager;\n    52→import com.fsck.k9.mailstore.StorageManager;\n    53→import com.fsck.k9.notification.NotificationChannelManager;\n    54→import com.fsck.k9.preferences.StorageEditor;\n    55→import com.fsck.k9.search.LocalSearch;\n    56→import com.fsck.k9.search.SearchAccount;\n    57→import com.fsck.k9.search.SearchSpecification;\n    58→import com.fsck.k9.search.SearchSpecification.Attribute;\n    59→import com.fsck.k9.search.SearchSpecification.SearchCondition;\n    60→import com.fsck.k9.search.SearchSpecification.SearchField;\n    61→import com.fsck.k9.ui.K9Drawer;\n    62→import com.fsck.k9.ui.R;\n    63→import com.fsck.k9.ui.messagelist.MessageListViewModel;\n    64→import com.fsck.k9.ui.messagelist.MessageListViewModelFactory;\n    65→import com.fsck.k9.ui.messageview.MessageViewFragment;\n    66→import com.fsck.k9.ui.messageview.MessageViewFragment.MessageViewFragmentListener;\n    67→import com.fsck.k9.ui.settings.SettingsActivity;\n    68→import com.fsck.k9.view.MessageHeader;\n    69→import com.fsck.k9.view.MessageTitleView;\n    70→import com.fsck.k9.view.ViewSwitcher;\n    71→import com.fsck.k9.view.ViewSwitcher.OnSwitchCompleteListener;\n    72→import com.mikepenz.materialdrawer.Drawer.OnDrawerListener;\n    73→\n    74→import java.util.Collection;\n    75→import java.util.List;\n    76→\n    77→import de.cketti.library.changelog.ChangeLog;\n    78→import timber.log.Timber;\n    79→\n    80→\n    81→/**\n    82→ * MessageList is the primary user interface for the program. This Activity\n    83→ * shows a list of messages.\n    84→ * From this Activity the user can perform all standard message operations.\n    85→ */\n    86→public class MessageList extends K9Activity implements MessageListFragmentListener,\n    87→        MessageViewFragmentListener, OnBackStackChangedListener, OnSwipeGestureListener,\n    88→        OnSwitchCompleteListener {\n    89→\n    90→    private static final String EXTRA_SEARCH = \"search_bytes\";\n    91→    private static final String EXTRA_NO_THREADING = \"no_threading\";\n    92→\n    93→    private static final String ACTION_SHORTCUT = \"shortcut\";\n    94→    private static final String EXTRA_SPECIAL_FOLDER = \"special_folder\";\n    95→\n    96→    private static final String EXTRA_MESSAGE_REFERENCE = \"message_reference\";\n    97→\n    98→    // used for remote search\n    99→    public static final String EXTRA_SEARCH_ACCOUNT = \"com.fsck.k9.search_account\";\n   100→    private static final String EXTRA_SEARCH_FOLDER = \"com.fsck.k9.search_folder\";\n   101→\n   102→    private static final String STATE_DISPLAY_MODE = \"displayMode\";\n   103→    private static final String STATE_MESSAGE_LIST_WAS_DISPLAYED = \"messageListWasDisplayed\";\n   104→    private static final String STATE_FIRST_BACK_STACK_ID = \"firstBackstackId\";\n   105→\n   106→    // Used for navigating to next/previous message\n   107→    private static final int PREVIOUS = 1;\n   108→    private static final int NEXT = 2;\n   109→\n   110→    public static final int REQUEST_MASK_PENDING_INTENT = 1 << 15;\n   111→\n   112→    public static void actionDisplaySearch(Context context, SearchSpecification search,\n   113→            boolean noThreading, boolean newTask) {\n   114→        actionDisplaySearch(context, search, noThreading, newTask, true);\n   115→    }\n   116→\n   117→    public static void actionDisplaySearch(Context context, SearchSpecification search,\n   118→            boolean noThreading, boolean newTask, boolean clearTop) {\n   119→        context.startActivity(\n   120→                intentDisplaySearch(context, search, noThreading, newTask, clearTop));\n   121→    }\n   122→\n   123→    public static Intent intentDisplaySearch(Context context, SearchSpecification search,\n   124→            boolean noThreading, boolean newTask, boolean clearTop) {\n   125→        Intent intent = new Intent(context, MessageList.class);\n   126→        intent.putExtra(EXTRA_SEARCH, ParcelableUtil.marshall(search));\n   127→        intent.putExtra(EXTRA_NO_THREADING, noThreading);\n   128→\n   129→        if (clearTop) {\n   130→            intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\n   131→        }\n   132→        if (newTask) {\n   133→            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n   134→        }\n   135→\n   136→        return intent;\n   137→    }\n   138→\n   139→    public static Intent shortcutIntent(Context context, String specialFolder) {\n   140→        Intent intent = new Intent(context, MessageList.class);\n   141→        intent.setAction(ACTION_SHORTCUT);\n   142→        intent.putExtra(EXTRA_SPECIAL_FOLDER, specialFolder);\n   143→        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\n   144→        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n   145→\n   146→        return intent;\n   147→    }\n   148→\n   149→    public static Intent actionDisplayMessageIntent(Context context,\n   150→            MessageReference messageReference) {\n   151→        Intent intent = new Intent(context, MessageList.class);\n   152→        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\n   153→        intent.putExtra(EXTRA_MESSAGE_REFERENCE, messageReference.toIdentityString());\n   154→        return intent;\n   155→    }\n   156→\n   157→\n   158→    private enum DisplayMode {\n   159→        MESSAGE_LIST,\n   160→        MESSAGE_VIEW,\n   161→        SPLIT_VIEW\n   162→    }\n   163→\n   164→\n   165→    protected final SearchStatusManager searchStatusManager = DI.get(SearchStatusManager.class);\n   166→    private StorageManager.StorageListener mStorageListener = new StorageListenerImplementation();\n   167→    private final Preferences preferences = DI.get(Preferences.class);\n   168→    private final NotificationChannelManager channelUtils = DI.get(NotificationChannelManager.class);\n   169→\n   170→    private ActionBar actionBar;\n   171→    private ActionBarDrawerToggle drawerToggle;\n   172→    private K9Drawer drawer;\n   173→    private FragmentTransaction openFolderTransaction;\n   174→    private View actionBarMessageList;\n   175→    private View actionBarMessageView;\n   176→    private MessageTitleView actionBarSubject;\n   177→    private TextView actionBarTitle;\n   178→    private TextView actionBarSubTitle;\n   179→    private Menu menu;\n   180→\n   181→    private ViewGroup messageViewContainer;\n   182→    private View messageViewPlaceHolder;\n   183→\n   184→    private MessageListFragment messageListFragment;\n   185→    private MessageViewFragment messageViewFragment;\n   186→    private int firstBackStackId = -1;\n   187→\n   188→    private Account account;\n   189→    private LocalSearch search;\n   190→    private boolean singleFolderMode;\n   191→    private boolean singleAccountMode;\n   192→\n   193→    private ProgressBar actionBarProgress;\n   194→    private MenuItem menuButtonCheckMail;\n   195→    private View actionButtonIndeterminateProgress;\n   196→    private int lastDirection = (K9.messageViewShowNext()) ? NEXT : PREVIOUS;\n   197→\n   198→    /**\n   199→     * {@code true} if the message list should be displayed as flat list (i.e. no threading)\n   200→     * regardless whether or not message threading was enabled in the settings. This is used for\n   201→     * filtered views, e.g. when only displaying the unread messages in a folder.\n   202→     */\n   203→    private boolean noThreading;\n   204→\n   205→    private DisplayMode displayMode;\n   206→    private MessageReference messageReference;\n   207→\n   208→    /**\n   209→     * {@code true} when the message list was displayed once. This is used in\n   210→     * {@link #onBackPressed()} to decide whether to go from the message view to the message list or\n   211→     * finish the activity.\n   212→     */\n   213→    private boolean messageListWasDisplayed = false;\n   214→    private ViewSwitcher viewSwitcher;\n   215→\n   216→\n   217→    @Override\n   218→    public void onCreate(Bundle savedInstanceState) {\n   219→        super.onCreate(savedInstanceState);\n   220→\n   221→        if (UpgradeDatabases.actionUpgradeDatabases(this, getIntent())) {\n   222→            finish();\n   223→            return;\n   224→        }\n   225→\n   226→        if (useSplitView()) {\n   227→            setContentView(R.layout.split_message_list);\n   228→        } else {\n   229→            setContentView(R.layout.message_list);\n   230→            viewSwitcher = findViewById(R.id.container);\n   231→            viewSwitcher.setFirstInAnimation(AnimationUtils.loadAnimation(this, R.anim.slide_in_left));\n   232→            viewSwitcher.setFirstOutAnimation(AnimationUtils.loadAnimation(this, R.anim.slide_out_right));\n   233→            viewSwitcher.setSecondInAnimation(AnimationUtils.loadAnimation(this, R.anim.slide_in_right));\n   234→            viewSwitcher.setSecondOutAnimation(AnimationUtils.loadAnimation(this, R.anim.slide_out_left));\n   235→            viewSwitcher.setOnSwitchCompleteListener(this);\n   236→        }\n   237→\n   238→        initializeActionBar();\n   239→        initializeDrawer(savedInstanceState);\n   240→\n   241→        // Enable gesture detection for MessageLists\n   242→        setupGestureDetector(this);\n   243→\n   244→        if (!decodeExtras(getIntent())) {\n   245→            return;\n   246→        }\n   247→\n   248→        ViewModelProvider viewModelProvider = ViewModelProviders.of(this, new MessageListViewModelFactory());\n   249→        MessageListViewModel viewModel = viewModelProvider.get(MessageListViewModel.class);\n   250→\n   251→        if (isDrawerEnabled()) {\n   252→            viewModel.getFolders(account).observe(this, new Observer<List<Folder>>() {\n   253→                @Override\n   254→                public void onChanged(@Nullable List<Folder> folders) {\n   255→                    drawer.setUserFolders(folders);\n   256→                }\n   257→            });\n   258→        }\n   259→\n   260→        findFragments();\n   261→        initializeDisplayMode(savedInstanceState);\n   262→        initializeLayout();\n   263→        initializeFragments();\n   264→        displayViews();\n   265→        channelUtils.updateChannels();\n   266→\n   267→        ChangeLog cl = new ChangeLog(this);\n   268→        if (cl.isFirstRun()) {\n   269→            cl.getLogDialog().show();\n   270→        }\n   271→    }\n   272→\n   273→    @Override\n   274→    public void onNewIntent(Intent intent) {\n   275→        super.onNewIntent(intent);\n   276→\n   277→        if (isFinishing()) {\n   278→            return;\n   279→        }\n   280→\n   281→        setIntent(intent);\n   282→\n   283→        if (firstBackStackId >= 0) {\n   284→            getFragmentManager().popBackStackImmediate(firstBackStackId,\n   285→                    FragmentManager.POP_BACK_STACK_INCLUSIVE);\n   286→            firstBackStackId = -1;\n   287→        }\n   288→        removeMessageListFragment();\n   289→        removeMessageViewFragment();\n   290→\n   291→        messageReference = null;\n   292→        search = null;\n   293→\n   294→        if (!decodeExtras(intent)) {\n   295→            return;\n   296→        }\n   297→\n   298→        initializeDisplayMode(null);\n   299→        initializeFragments();\n   300→        displayViews();\n   301→    }\n   302→\n   303→    /**\n   304→     * Get references to existing fragments if the activity was restarted.\n   305→     */\n   306→    private void findFragments() {\n   307→        FragmentManager fragmentManager = getSupportFragmentManager();\n   308→        messageListFragment = (MessageListFragment) fragmentManager.findFragmentById(R.id.message_list_container);\n   309→        messageViewFragment = (MessageViewFragment) fragmentManager.findFragmentById(R.id.message_view_container);\n   310→\n   311→        if (messageListFragment != null) {\n   312→            initializeFromLocalSearch(messageListFragment.getLocalSearch());\n   313→        }\n   314→    }\n   315→\n   316→    /**\n   317→     * Create fragment instances if necessary.\n   318→     *\n   319→     * @see #findFragments()\n   320→     */\n   321→    private void initializeFragments() {\n   322→        FragmentManager fragmentManager = getSupportFragmentManager();\n   323→        fragmentManager.addOnBackStackChangedListener(this);\n   324→\n   325→        boolean hasMessageListFragment = (messageListFragment != null);\n   326→\n   327→        if (!hasMessageListFragment) {\n   328→            FragmentTransaction ft = fragmentManager.beginTransaction();\n   329→            messageListFragment = MessageListFragment.newInstance(search, false,\n   330→                    (K9.isThreadedViewEnabled() && !noThreading));\n   331→            ft.add(R.id.message_list_container, messageListFragment);\n   332→            ft.commit();\n   333→        }\n   334→\n   335→        // Check if the fragment wasn't restarted and has a MessageReference in the arguments. If\n   336→        // so, open the referenced message.\n   337→        if (!hasMessageListFragment && messageViewFragment == null &&\n   338→                messageReference != null) {\n   339→            openMessage(messageReference);\n   340→        }\n   341→    }\n   342→\n   343→    /**\n   344→     * Set the initial display mode (message list, message view, or split view).\n   345→     *\n   346→     * <p><strong>Note:</strong>\n   347→     * This method has to be called after {@link #findFragments()} because the result depends on\n   348→     * the availability of a {@link MessageViewFragment} instance.\n   349→     * </p>\n   350→     *\n   351→     * @param savedInstanceState\n   352→     *         The saved instance state that was passed to the activity as argument to\n   353→     *         {@link #onCreate(Bundle)}. May be {@code null}.\n   354→     */\n   355→    private void initializeDisplayMode(Bundle savedInstanceState) {\n   356→        if (useSplitView()) {\n   357→            displayMode = DisplayMode.SPLIT_VIEW;\n   358→            return;\n   359→        }\n   360→\n   361→        if (savedInstanceState != null) {\n   362→            DisplayMode savedDisplayMode =\n   363→                    (DisplayMode) savedInstanceState.getSerializable(STATE_DISPLAY_MODE);\n   364→            if (savedDisplayMode != DisplayMode.SPLIT_VIEW) {\n   365→                displayMode = savedDisplayMode;\n   366→                return;\n   367→            }\n   368→        }\n   369→\n   370→        if (messageViewFragment != null || messageReference != null) {\n   371→            displayMode = DisplayMode.MESSAGE_VIEW;\n   372→        } else {\n   373→            displayMode = DisplayMode.MESSAGE_LIST;\n   374→        }\n   375→    }\n   376→\n   377→    private boolean useSplitView() {\n   378→        SplitViewMode splitViewMode = K9.getSplitViewMode();\n   379→        int orientation = getResources().getConfiguration().orientation;\n   380→\n   381→        return (splitViewMode == SplitViewMode.ALWAYS ||\n   382→                (splitViewMode == SplitViewMode.WHEN_IN_LANDSCAPE &&\n   383→                orientation == Configuration.ORIENTATION_LANDSCAPE));\n   384→    }\n   385→\n   386→    private void initializeLayout() {\n   387→        messageViewContainer = findViewById(R.id.message_view_container);\n   388→\n   389→        LayoutInflater layoutInflater = getLayoutInflater();\n   390→        messageViewPlaceHolder = layoutInflater.inflate(R.layout.empty_message_view, messageViewContainer, false);\n   391→    }\n   392→\n   393→    private void displayViews() {\n   394→        switch (displayMode) {\n   395→            case MESSAGE_LIST: {\n   396→                showMessageList();\n   397→                break;\n   398→            }\n   399→            case MESSAGE_VIEW: {\n   400→                showMessageView();\n   401→                break;\n   402→            }\n   403→            case SPLIT_VIEW: {\n   404→                messageListWasDisplayed = true;\n   405→                if (messageViewFragment == null) {\n   406→                    showMessageViewPlaceHolder();\n   407→                } else {\n   408→                    MessageReference activeMessage = messageViewFragment.getMessageReference();\n   409→                    if (activeMessage != null) {\n   410→                        messageListFragment.setActiveMessage(activeMessage);\n   411→                    }\n   412→                }\n   413→                break;\n   414→            }\n   415→        }\n   416→    }\n   417→\n   418→    private boolean decodeExtras(Intent intent) {\n   419→        String action = intent.getAction();\n   420→        if (Intent.ACTION_VIEW.equals(action) && intent.getData() != null) {\n   421→            Uri uri = intent.getData();\n   422→            List<String> segmentList = uri.getPathSegments();\n   423→\n   424→            String accountId = segmentList.get(0);\n   425→            Collection<Account> accounts = preferences.getAvailableAccounts();\n   426→            for (Account account : accounts) {\n   427→                if (String.valueOf(account.getAccountNumber()).equals(accountId)) {\n   428→                    String folderServerId = segmentList.get(1);\n   429→                    String messageUid = segmentList.get(2);\n   430→                    messageReference = new MessageReference(account.getUuid(), folderServerId, messageUid, null);\n   431→                    break;\n   432→                }\n   433→            }\n   434→        } else if (ACTION_SHORTCUT.equals(action)) {\n   435→            // Handle shortcut intents\n   436→            String specialFolder = intent.getStringExtra(EXTRA_SPECIAL_FOLDER);\n   437→            if (SearchAccount.UNIFIED_INBOX.equals(specialFolder)) {\n   438→                search = SearchAccount.createUnifiedInboxAccount().getRelatedSearch();\n   439→            } else if (SearchAccount.ALL_MESSAGES.equals(specialFolder)) {\n   440→                search = SearchAccount.createAllMessagesAccount().getRelatedSearch();\n   441→            }\n   442→        } else if (intent.getStringExtra(SearchManager.QUERY) != null) {\n   443→            // check if this intent comes from the system search ( remote )\n   444→            if (Intent.ACTION_SEARCH.equals(intent.getAction())) {\n   445→                //Query was received from Search Dialog\n   446→                String query = intent.getStringExtra(SearchManager.QUERY).trim();\n   447→\n   448→                search = new LocalSearch(getString(R.string.search_results));\n   449→                search.setManualSearch(true);\n   450→                noThreading = true;\n   451→\n   452→                search.or(new SearchCondition(SearchField.SENDER, Attribute.CONTAINS, query));\n   453→                search.or(new SearchCondition(SearchField.SUBJECT, Attribute.CONTAINS, query));\n   454→                search.or(new SearchCondition(SearchField.MESSAGE_CONTENTS, Attribute.CONTAINS, query));\n   455→\n   456→                Bundle appData = intent.getBundleExtra(SearchManager.APP_DATA);\n   457→                if (appData != null) {\n   458→                    search.addAccountUuid(appData.getString(EXTRA_SEARCH_ACCOUNT));\n   459→                    // searches started from a folder list activity will provide an account, but no folder\n   460→                    if (appData.getString(EXTRA_SEARCH_FOLDER) != null) {\n   461→                        search.addAllowedFolder(appData.getString(EXTRA_SEARCH_FOLDER));\n   462→                    }\n   463→                } else {\n   464→                    search.addAccountUuid(LocalSearch.ALL_ACCOUNTS);\n   465→                }\n   466→            }\n   467→        } else {\n   468→            // regular LocalSearch object was passed\n   469→            search = intent.hasExtra(EXTRA_SEARCH) ?\n   470→                    ParcelableUtil.unmarshall(intent.getByteArrayExtra(EXTRA_SEARCH), LocalSearch.CREATOR) : null;\n   471→            noThreading = intent.getBooleanExtra(EXTRA_NO_THREADING, false);\n   472→        }\n   473→\n   474→        if (messageReference == null) {\n   475→            String messageReferenceString = intent.getStringExtra(EXTRA_MESSAGE_REFERENCE);\n   476→            messageReference = MessageReference.parse(messageReferenceString);\n   477→        }\n   478→\n   479→        if (messageReference != null) {\n   480→            search = new LocalSearch();\n   481→            search.addAccountUuid(messageReference.getAccountUuid());\n   482→            String folderServerId = messageReference.getFolderServerId();\n   483→            search.addAllowedFolder(folderServerId);\n   484→        }\n   485→\n   486→        if (search == null) {\n   487→            // We've most likely been started by an old unread widget\n   488→            String accountUuid = intent.getStringExtra(\"account\");\n   489→            String folderServerId = intent.getStringExtra(\"folder\");\n   490→\n   491→            search = new LocalSearch(folderServerId);\n   492→            search.addAccountUuid((accountUuid == null) ? \"invalid\" : accountUuid);\n   493→            if (folderServerId != null) {\n   494→                search.addAllowedFolder(folderServerId);\n   495→            }\n   496→        }\n   497→\n   498→        initializeFromLocalSearch(search);\n   499→\n   500→        if (singleAccountMode && (account == null || !account.isAvailable(this))) {\n   501→            Timber.i(\"not opening MessageList of unavailable account\");\n   502→            onAccountUnavailable();\n   503→            return false;\n   504→        }\n   505→\n   506→        return true;\n   507→    }\n   508→\n   509→    @Override\n   510→    public void onPause() {\n   511→        super.onPause();\n   512→\n   513→        StorageManager.getInstance(getApplication()).removeListener(mStorageListener);\n   514→    }\n   515→\n   516→    @Override\n   517→    public void onResume() {\n   518→        super.onResume();\n   519→\n   520→        if (!(this instanceof Search)) {\n   521→            //necessary b/c no guarantee Search.onStop will be called before MessageList.onResume\n   522→            //when returning from search results\n   523→            searchStatusManager.setActive(false);\n   524→        }\n   525→\n   526→        if (account != null && !account.isAvailable(this)) {\n   527→            onAccountUnavailable();\n   528→            return;\n   529→        }\n   530→        StorageManager.getInstance(getApplication()).addListener(mStorageListener);\n   531→    }\n   532→\n   533→    @Override\n   534→    protected void onStart() {\n   535→        super.onStart();\n   536→        Contacts.clearCache();\n   537→    }\n   538→\n   539→    @Override\n   540→    public void onSaveInstanceState(Bundle outState) {\n   541→        super.onSaveInstanceState(outState);\n   542→\n   543→        outState.putSerializable(STATE_DISPLAY_MODE, displayMode);\n   544→        outState.putBoolean(STATE_MESSAGE_LIST_WAS_DISPLAYED, messageListWasDisplayed);\n   545→        outState.putInt(STATE_FIRST_BACK_STACK_ID, firstBackStackId);\n   546→    }\n   547→\n   548→    @Override\n   549→    public void onRestoreInstanceState(Bundle savedInstanceState) {\n   550→        super.onRestoreInstanceState(savedInstanceState);\n   551→\n   552→        messageListWasDisplayed = savedInstanceState.getBoolean(STATE_MESSAGE_LIST_WAS_DISPLAYED);\n   553→        firstBackStackId = savedInstanceState.getInt(STATE_FIRST_BACK_STACK_ID);\n   554→    }\n   555→\n   556→    private void initializeActionBar() {\n   557→        actionBar = getSupportActionBar();\n   558→\n   559→        actionBar.setDisplayShowCustomEnabled(true);\n   560→        actionBar.setCustomView(R.layout.actionbar_custom);\n   561→\n   562→        View customView = actionBar.getCustomView();\n   563→        actionBarMessageList = customView.findViewById(R.id.actionbar_message_list);\n   564→        actionBarMessageView = customView.findViewById(R.id.actionbar_message_view);\n   565→        actionBarSubject = customView.findViewById(R.id.message_title_view);\n   566→        actionBarTitle = customView.findViewById(R.id.actionbar_title_first);\n   567→        actionBarSubTitle = customView.findViewById(R.id.actionbar_title_sub);\n   568→        actionBarProgress = customView.findViewById(R.id.actionbar_progress);\n   569→        actionButtonIndeterminateProgress = getActionButtonIndeterminateProgress();\n   570→\n   571→        actionBar.setDisplayHomeAsUpEnabled(true);\n   572→    }\n   573→\n   574→    private void initializeDrawer(Bundle savedInstanceState) {\n   575→        if (!isDrawerEnabled()) {\n   576→            return;\n   577→        }\n   578→\n   579→        drawer = new K9Drawer(this, savedInstanceState);\n   580→\n   581→        DrawerLayout drawerLayout = drawer.getLayout();\n   582→        drawerToggle = new ActionBarDrawerToggle(\n   583→                this, drawerLayout, null,\n   584→                R.string.navigation_drawer_open, R.string.navigation_drawer_close\n   585→        );\n   586→        drawerLayout.addDrawerListener(drawerToggle);\n   587→        drawerToggle.syncState();\n   588→    }\n   589→\n   590→    public OnDrawerListener createOnDrawerListener() {\n   591→        return new OnDrawerListener() {\n   592→            @Override\n   593→            public void onDrawerClosed(View drawerView) {\n   594→                if (openFolderTransaction != null) {\n   595→                    openFolderTransaction.commit();\n   596→                    openFolderTransaction = null;\n   597→                }\n   598→            }\n   599→\n   600→            @Override\n   601→            public void onDrawerOpened(View drawerView) {\n   602→                // Do nothing\n   603→            }\n   604→\n   605→            @Override\n   606→            public void onDrawerSlide(View drawerView, float slideOffset) {\n   607→                // Do nothing\n   608→            }\n   609→        };\n   610→    }\n   611→\n   612→    public void openFolder(String folderName) {\n   613→        LocalSearch search = new LocalSearch(folderName);\n   614→        search.addAccountUuid(account.getUuid());\n   615→        search.addAllowedFolder(folderName);\n   616→\n   617→        performSearch(search);\n   618→    }\n   619→\n   620→    public void openUnifiedInbox() {\n   621→        drawer.selectUnifiedInbox();\n   622→        performSearch(SearchAccount.createUnifiedInboxAccount().getRelatedSearch());\n   623→    }\n   624→\n   625→    private void performSearch(LocalSearch search) {\n   626→        initializeFromLocalSearch(search);\n   627→\n   628→        FragmentManager fragmentManager = getSupportFragmentManager();\n   629→        openFolderTransaction = fragmentManager.beginTransaction();\n   630→        messageListFragment = MessageListFragment.newInstance(search, false, K9.isThreadedViewEnabled());\n   631→        openFolderTransaction.replace(R.id.message_list_container, messageListFragment);\n   632→    }\n   633→\n   634→    protected boolean isDrawerEnabled() {\n   635→        return true;\n   636→    }\n   637→\n   638→    @SuppressLint(\"InflateParams\")\n   639→    private View getActionButtonIndeterminateProgress() {\n   640→        return getLayoutInflater().inflate(R.layout.actionbar_indeterminate_progress_actionview, null);\n   641→    }\n   642→\n   643→    @Override\n   644→    public boolean dispatchKeyEvent(KeyEvent event) {\n   645→        boolean ret = false;\n   646→        if (KeyEvent.ACTION_DOWN == event.getAction()) {\n   647→            ret = onCustomKeyDown(event.getKeyCode(), event);\n   648→        }\n   649→        if (!ret) {\n   650→            ret = super.dispatchKeyEvent(event);\n   651→        }\n   652→        return ret;\n   653→    }\n   654→\n   655→    @Override\n   656→    public void onBackPressed() {\n   657→        if (displayMode == DisplayMode.MESSAGE_VIEW && messageListWasDisplayed) {\n   658→            showMessageList();\n   659→        } else {\n   660→            super.onBackPressed();\n   661→        }\n   662→    }\n   663→\n   664→    /**\n   665→     * Handle hotkeys\n   666→     *\n   667→     * <p>\n   668→     * This method is called by {@link #dispatchKeyEvent(KeyEvent)} before any view had the chance\n   669→     * to consume this key event.\n   670→     * </p>\n   671→     *\n   672→     * @param keyCode\n   673→     *         The value in {@code event.getKeyCode()}.\n   674→     * @param event\n   675→     *         Description of the key event.\n   676→     *\n   677→     * @return {@code true} if this event was consumed.\n   678→     */\n   679→    public boolean onCustomKeyDown(final int keyCode, final KeyEvent event) {\n   680→        switch (keyCode) {\n   681→            case KeyEvent.KEYCODE_VOLUME_UP: {\n   682→                if (messageViewFragment != null && displayMode != DisplayMode.MESSAGE_LIST &&\n   683→                        K9.useVolumeKeysForNavigationEnabled()) {\n   684→                    showPreviousMessage();\n   685→                    return true;\n   686→                } else if (displayMode != DisplayMode.MESSAGE_VIEW &&\n   687→                        K9.useVolumeKeysForListNavigationEnabled()) {\n   688→                    messageListFragment.onMoveUp();\n   689→                    return true;\n   690→                }\n   691→\n   692→                break;\n   693→            }\n   694→            case KeyEvent.KEYCODE_VOLUME_DOWN: {\n   695→                if (messageViewFragment != null && displayMode != DisplayMode.MESSAGE_LIST &&\n   696→                        K9.useVolumeKeysForNavigationEnabled()) {\n   697→                    showNextMessage();\n   698→                    return true;\n   699→                } else if (displayMode != DisplayMode.MESSAGE_VIEW &&\n   700→                        K9.useVolumeKeysForListNavigationEnabled()) {\n   701→                    messageListFragment.onMoveDown();\n   702→                    return true;\n   703→                }\n   704→\n   705→                break;\n   706→            }\n   707→            case KeyEvent.KEYCODE_C: {\n   708→                messageListFragment.onCompose();\n   709→                return true;\n   710→            }\n   711→            case KeyEvent.KEYCODE_Q: {\n   712→                if (messageListFragment != null && messageListFragment.isSingleAccountMode()) {\n   713→                    onShowFolderList();\n   714→                }\n   715→                return true;\n   716→            }\n   717→            case KeyEvent.KEYCODE_O: {\n   718→                messageListFragment.onCycleSort();\n   719→                return true;\n   720→            }\n   721→            case KeyEvent.KEYCODE_I: {\n   722→                messageListFragment.onReverseSort();\n   723→                return true;\n   724→            }\n   725→            case KeyEvent.KEYCODE_DEL:\n   726→            case KeyEvent.KEYCODE_D: {\n   727→                if (displayMode == DisplayMode.MESSAGE_LIST) {\n   728→                    messageListFragment.onDelete();\n   729→                } else if (messageViewFragment != null) {\n   730→                    messageViewFragment.onDelete();\n   731→                }\n   732→                return true;\n   733→            }\n   734→            case KeyEvent.KEYCODE_S: {\n   735→                messageListFragment.toggleMessageSelect();\n   736→                return true;\n   737→            }\n   738→            case KeyEvent.KEYCODE_G: {\n   739→                if (displayMode == DisplayMode.MESSAGE_LIST) {\n   740→                    messageListFragment.onToggleFlagged();\n   741→                } else if (messageViewFragment != null) {\n   742→                    messageViewFragment.onToggleFlagged();\n   743→                }\n   744→                return true;\n   745→            }\n   746→            case KeyEvent.KEYCODE_M: {\n   747→                if (displayMode == DisplayMode.MESSAGE_LIST) {\n   748→                    messageListFragment.onMove();\n   749→                } else if (messageViewFragment != null) {\n   750→                    messageViewFragment.onMove();\n   751→                }\n   752→                return true;\n   753→            }\n   754→            case KeyEvent.KEYCODE_V: {\n   755→                if (displayMode == DisplayMode.MESSAGE_LIST) {\n   756→                    messageListFragment.onArchive();\n   757→                } else if (messageViewFragment != null) {\n   758→                    messageViewFragment.onArchive();\n   759→                }\n   760→                return true;\n   761→            }\n   762→            case KeyEvent.KEYCODE_Y: {\n   763→                if (displayMode == DisplayMode.MESSAGE_LIST) {\n   764→                    messageListFragment.onCopy();\n   765→                } else if (messageViewFragment != null) {\n   766→                    messageViewFragment.onCopy();\n   767→                }\n   768→                return true;\n   769→            }\n   770→            case KeyEvent.KEYCODE_Z: {\n   771→                if (displayMode == DisplayMode.MESSAGE_LIST) {\n   772→                    messageListFragment.onToggleRead();\n   773→                } else if (messageViewFragment != null) {\n   774→                    messageViewFragment.onToggleRead();\n   775→                }\n   776→                return true;\n   777→            }\n   778→            case KeyEvent.KEYCODE_F: {\n   779→                if (messageViewFragment != null) {\n   780→                    messageViewFragment.onForward();\n   781→                }\n   782→                return true;\n   783→            }\n   784→            case KeyEvent.KEYCODE_A: {\n   785→                if (messageViewFragment != null) {\n   786→                    messageViewFragment.onReplyAll();\n   787→                }\n   788→                return true;\n   789→            }\n   790→            case KeyEvent.KEYCODE_R: {\n   791→                if (messageViewFragment != null) {\n   792→                    messageViewFragment.onReply();\n   793→                }\n   794→                return true;\n   795→            }\n   796→            case KeyEvent.KEYCODE_J:\n   797→            case KeyEvent.KEYCODE_P: {\n   798→                if (messageViewFragment != null) {\n   799→                    showPreviousMessage();\n   800→                }\n   801→                return true;\n   802→            }\n   803→            case KeyEvent.KEYCODE_N:\n   804→            case KeyEvent.KEYCODE_K: {\n   805→                if (messageViewFragment != null) {\n   806→                    showNextMessage();\n   807→                }\n   808→                return true;\n   809→            }\n   810→            /* FIXME\n   811→            case KeyEvent.KEYCODE_Z: {\n   812→                messageViewFragment.zoom(event);\n   813→                return true;\n   814→            }*/\n   815→            case KeyEvent.KEYCODE_H: {\n   816→                Toast toast;\n   817→                if (displayMode == DisplayMode.MESSAGE_LIST) {\n   818→                    toast = Toast.makeText(this, R.string.message_list_help_key, Toast.LENGTH_LONG);\n   819→                } else {\n   820→                    toast = Toast.makeText(this, R.string.message_view_help_key, Toast.LENGTH_LONG);\n   821→                }\n   822→                toast.show();\n   823→                return true;\n   824→            }\n   825→            case KeyEvent.KEYCODE_DPAD_LEFT: {\n   826→                if (messageViewFragment != null && displayMode == DisplayMode.MESSAGE_VIEW) {\n   827→                    return showPreviousMessage();\n   828→                }\n   829→                return false;\n   830→            }\n   831→            case KeyEvent.KEYCODE_DPAD_RIGHT: {\n   832→                if (messageViewFragment != null && displayMode == DisplayMode.MESSAGE_VIEW) {\n   833→                    return showNextMessage();\n   834→                }\n   835→                return false;\n   836→            }\n   837→\n   838→        }\n   839→\n   840→        return false;\n   841→    }\n   842→\n   843→    @Override\n   844→    public boolean onKeyUp(int keyCode, KeyEvent event) {\n   845→        // Swallow these events too to avoid the audible notification of a volume change\n   846→        if (K9.useVolumeKeysForListNavigationEnabled()) {\n   847→            if ((keyCode == KeyEvent.KEYCODE_VOLUME_UP) || (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN)) {\n   848→                Timber.v(\"Swallowed key up.\");\n   849→                return true;\n   850→            }\n   851→        }\n   852→        return super.onKeyUp(keyCode, event);\n   853→    }\n   854→\n   855→    private void onAccounts() {\n   856→        Accounts.listAccounts(this);\n   857→        finish();\n   858→    }\n   859→\n   860→    private void onShowFolderList() {\n   861→        FolderList.actionHandleAccount(this, account);\n   862→        finish();\n   863→    }\n   864→\n   865→    private void onEditSettings() {\n   866→        SettingsActivity.launch(this);\n   867→    }\n   868→\n   869→    @Override\n   870→    public boolean onSearchRequested() {\n   871→        return messageListFragment.onSearchRequested();\n   872→    }\n   873→\n   874→    @Override\n   875→    public boolean onOptionsItemSelected(MenuItem item) {\n   876→        int id = item.getItemId();\n   877→        if (id == android.R.id.home) {\n   878→            if (displayMode != DisplayMode.MESSAGE_VIEW && !isAdditionalMessageListDisplayed()) {\n   879→                if (isDrawerEnabled()) {\n   880→                    if (drawer.isOpen()) {\n   881→                        drawer.close();\n   882→                    } else {\n   883→                        drawer.open();\n   884→                    }\n   885→                } else {\n   886→                    finish();\n   887→                }\n   888→            } else {\n   889→                goBack();\n   890→            }\n   891→            return true;\n   892→        } else if (id == R.id.compose) {\n   893→            messageListFragment.onCompose();\n   894→            return true;\n   895→        } else if (id == R.id.toggle_message_view_theme) {\n   896→            onToggleTheme();\n   897→            return true;\n   898→        } else if (id == R.id.check_mail) {     // MessageList\n   899→            messageListFragment.checkMail();\n   900→            return true;\n   901→        } else if (id == R.id.set_sort_date) {\n   902→            messageListFragment.changeSort(SortType.SORT_DATE);\n   903→            return true;\n   904→        } else if (id == R.id.set_sort_arrival) {\n   905→            messageListFragment.changeSort(SortType.SORT_ARRIVAL);\n   906→            return true;\n   907→        } else if (id == R.id.set_sort_subject) {\n   908→            messageListFragment.changeSort(SortType.SORT_SUBJECT);\n   909→            return true;\n   910→        } else if (id == R.id.set_sort_sender) {\n   911→            messageListFragment.changeSort(SortType.SORT_SENDER);\n   912→            return true;\n   913→        } else if (id == R.id.set_sort_flag) {\n   914→            messageListFragment.changeSort(SortType.SORT_FLAGGED);\n   915→            return true;\n   916→        } else if (id == R.id.set_sort_unread) {\n   917→            messageListFragment.changeSort(SortType.SORT_UNREAD);\n   918→            return true;\n   919→        } else if (id == R.id.set_sort_attach) {\n   920→            messageListFragment.changeSort(SortType.SORT_ATTACHMENT);\n   921→            return true;\n   922→        } else if (id == R.id.select_all) {\n   923→            messageListFragment.selectAll();\n   924→            return true;\n   925→        } else if (id == R.id.settings) {\n   926→            onEditSettings();\n   927→            return true;\n   928→        } else if (id == R.id.search) {\n   929→            messageListFragment.onSearchRequested();\n   930→            return true;\n   931→        } else if (id == R.id.search_remote) {\n   932→            messageListFragment.onRemoteSearch();\n   933→            return true;\n   934→        } else if (id == R.id.mark_all_as_read) {\n   935→            messageListFragment.confirmMarkAllAsRead();\n   936→            return true;\n   937→        } else if (id == R.id.show_folder_list) {\n   938→            onShowFolderList();\n   939→            return true;\n   940→        } else if (id == R.id.next_message) {   // MessageView\n   941→            showNextMessage();\n   942→            return true;\n   943→        } else if (id == R.id.previous_message) {\n   944→            showPreviousMessage();\n   945→            return true;\n   946→        } else if (id == R.id.delete) {\n   947→            messageViewFragment.onDelete();\n   948→            return true;\n   949→        } else if (id == R.id.reply) {\n   950→            messageViewFragment.onReply();\n   951→            return true;\n   952→        } else if (id == R.id.reply_all) {\n   953→            messageViewFragment.onReplyAll();\n   954→            return true;\n   955→        } else if (id == R.id.forward) {\n   956→            messageViewFragment.onForward();\n   957→            return true;\n   958→        } else if (id == R.id.forward_as_attachment) {\n   959→            messageViewFragment.onForwardAsAttachment();\n   960→            return true;\n   961→        } else if (id == R.id.share) {\n   962→            messageViewFragment.onSendAlternate();\n   963→            return true;\n   964→        } else if (id == R.id.toggle_unread) {\n   965→            messageViewFragment.onToggleRead();\n   966→            return true;\n   967→        } else if (id == R.id.archive || id == R.id.refile_archive) {\n   968→            messageViewFragment.onArchive();\n   969→            return true;\n   970→        } else if (id == R.id.spam || id == R.id.refile_spam) {\n   971→            messageViewFragment.onSpam();\n   972→            return true;\n   973→        } else if (id == R.id.move || id == R.id.refile_move) {\n   974→            messageViewFragment.onMove();\n   975→            return true;\n   976→        } else if (id == R.id.copy || id == R.id.refile_copy) {\n   977→            messageViewFragment.onCopy();\n   978→            return true;\n   979→        } else if (id == R.id.select_text) {\n   980→            messageViewFragment.onSelectText();\n   981→            return true;\n   982→        } else if (id == R.id.show_headers || id == R.id.hide_headers) {\n   983→            messageViewFragment.onToggleAllHeadersView();\n   984→            updateMenu();\n   985→            return true;\n   986→        }\n   987→\n   988→        if (!singleFolderMode) {\n   989→            // None of the options after this point are \"safe\" for search results\n   990→            //TODO: This is not true for \"unread\" and \"starred\" searches in regular folders\n   991→            return false;\n   992→        }\n   993→\n   994→        if (id == R.id.send_messages) {\n   995→            messageListFragment.onSendPendingMessages();\n   996→            return true;\n   997→        } else if (id == R.id.expunge) {\n   998→            messageListFragment.onExpunge();\n   999→            return true;\n  1000→        } else {\n  1001→            return super.onOptionsItemSelected(item);\n  1002→        }\n  1003→    }\n  1004→\n  1005→    @Override\n  1006→    public boolean onCreateOptionsMenu(Menu menu) {\n  1007→        getMenuInflater().inflate(R.menu.message_list_option, menu);\n  1008→        this.menu = menu;\n  1009→        menuButtonCheckMail = menu.findItem(R.id.check_mail);\n  1010→        return true;\n  1011→    }\n  1012→\n  1013→    @Override\n  1014→    public boolean onPrepareOptionsMenu(Menu menu) {\n  1015→        super.onPrepareOptionsMenu(menu);\n  1016→        configureMenu(menu);\n  1017→        return true;\n  1018→    }\n  1019→\n  1020→    /**\n  1021→     * Hide menu items not appropriate for the current context.\n  1022→     *\n  1023→     * <p><strong>Note:</strong>\n  1024→     * Please adjust the comments in {@code res/menu/message_list_option.xml} if you change the\n  1025→     * visibility of a menu item in this method.\n  1026→     * </p>\n  1027→     *\n  1028→     * @param menu\n  1029→     *         The {@link Menu} instance that should be modified. May be {@code null}; in that case\n  1030→     *         the method does nothing and immediately returns.\n  1031→     */\n  1032→    private void configureMenu(Menu menu) {\n  1033→        if (menu == null) {\n  1034→            return;\n  1035→        }\n  1036→\n  1037→        /*\n  1038→         * Set visibility of menu items related to the message view\n  1039→         */\n  1040→\n  1041→        if (displayMode == DisplayMode.MESSAGE_LIST\n  1042→                || messageViewFragment == null\n  1043→                || !messageViewFragment.isInitialized()) {\n  1044→            menu.findItem(R.id.next_message).setVisible(false);\n  1045→            menu.findItem(R.id.previous_message).setVisible(false);\n  1046→            menu.findItem(R.id.single_message_options).setVisible(false);\n  1047→            menu.findItem(R.id.delete).setVisible(false);\n  1048→            menu.findItem(R.id.compose).setVisible(false);\n  1049→            menu.findItem(R.id.archive).setVisible(false);\n  1050→            menu.findItem(R.id.move).setVisible(false);\n  1051→            menu.findItem(R.id.copy).setVisible(false);\n  1052→            menu.findItem(R.id.spam).setVisible(false);\n  1053→            menu.findItem(R.id.refile).setVisible(false);\n  1054→            menu.findItem(R.id.toggle_unread).setVisible(false);\n  1055→            menu.findItem(R.id.select_text).setVisible(false);\n  1056→            menu.findItem(R.id.toggle_message_view_theme).setVisible(false);\n  1057→            menu.findItem(R.id.show_headers).setVisible(false);\n  1058→            menu.findItem(R.id.hide_headers).setVisible(false);\n  1059→        } else {\n  1060→            // hide prev/next buttons in split mode\n  1061→            if (displayMode != DisplayMode.MESSAGE_VIEW) {\n  1062→                menu.findItem(R.id.next_message).setVisible(false);\n  1063→                menu.findItem(R.id.previous_message).setVisible(false);\n  1064→            } else {\n  1065→                MessageReference ref = messageViewFragment.getMessageReference();\n  1066→                boolean initialized = (messageListFragment != null &&\n  1067→                        messageListFragment.isLoadFinished());\n  1068→                boolean canDoPrev = (initialized && !messageListFragment.isFirst(ref));\n  1069→                boolean canDoNext = (initialized && !messageListFragment.isLast(ref));\n  1070→\n  1071→                MenuItem prev = menu.findItem(R.id.previous_message);\n  1072→                prev.setEnabled(canDoPrev);\n  1073→                prev.getIcon().setAlpha(canDoPrev ? 255 : 127);\n  1074→\n  1075→                MenuItem next = menu.findItem(R.id.next_message);\n  1076→                next.setEnabled(canDoNext);\n  1077→                next.getIcon().setAlpha(canDoNext ? 255 : 127);\n  1078→            }\n  1079→\n  1080→            MenuItem toggleTheme = menu.findItem(R.id.toggle_message_view_theme);\n  1081→            if (K9.useFixedMessageViewTheme()) {\n  1082→                toggleTheme.setVisible(false);\n  1083→            } else {\n  1084→                // Set title of menu item to switch to dark/light theme\n  1085→                if (K9.getK9MessageViewTheme() == K9.Theme.DARK) {\n  1086→                    toggleTheme.setTitle(R.string.message_view_theme_action_light);\n  1087→                } else {\n  1088→                    toggleTheme.setTitle(R.string.message_view_theme_action_dark);\n  1089→                }\n  1090→                toggleTheme.setVisible(true);\n  1091→            }\n  1092→\n  1093→            // Set title of menu item to toggle the read state of the currently displayed message\n  1094→            if (messageViewFragment.isMessageRead()) {\n  1095→                menu.findItem(R.id.toggle_unread).setTitle(R.string.mark_as_unread_action);\n  1096→            } else {\n  1097→                menu.findItem(R.id.toggle_unread).setTitle(R.string.mark_as_read_action);\n  1098→            }\n  1099→\n  1100→            // Jellybean has built-in long press selection support\n  1101→            menu.findItem(R.id.select_text).setVisible(Build.VERSION.SDK_INT < 16);\n  1102→\n  1103→            menu.findItem(R.id.delete).setVisible(K9.isMessageViewDeleteActionVisible());\n  1104→\n  1105→            /*\n  1106→             * Set visibility of copy, move, archive, spam in action bar and refile submenu\n  1107→             */\n  1108→            if (messageViewFragment.isCopyCapable()) {\n  1109→                menu.findItem(R.id.copy).setVisible(K9.isMessageViewCopyActionVisible());\n  1110→                menu.findItem(R.id.refile_copy).setVisible(true);\n  1111→            } else {\n  1112→                menu.findItem(R.id.copy).setVisible(false);\n  1113→                menu.findItem(R.id.refile_copy).setVisible(false);\n  1114→            }\n  1115→\n  1116→            if (messageViewFragment.isMoveCapable()) {\n  1117→                boolean canMessageBeArchived = messageViewFragment.canMessageBeArchived();\n  1118→                boolean canMessageBeMovedToSpam = messageViewFragment.canMessageBeMovedToSpam();\n  1119→\n  1120→                menu.findItem(R.id.move).setVisible(K9.isMessageViewMoveActionVisible());\n  1121→                menu.findItem(R.id.archive).setVisible(canMessageBeArchived &&\n  1122→                        K9.isMessageViewArchiveActionVisible());\n  1123→                menu.findItem(R.id.spam).setVisible(canMessageBeMovedToSpam &&\n  1124→                        K9.isMessageViewSpamActionVisible());\n  1125→\n  1126→                menu.findItem(R.id.refile_move).setVisible(true);\n  1127→                menu.findItem(R.id.refile_archive).setVisible(canMessageBeArchived);\n  1128→                menu.findItem(R.id.refile_spam).setVisible(canMessageBeMovedToSpam);\n  1129→            } else {\n  1130→                menu.findItem(R.id.move).setVisible(false);\n  1131→                menu.findItem(R.id.archive).setVisible(false);\n  1132→                menu.findItem(R.id.spam).setVisible(false);\n  1133→\n  1134→                menu.findItem(R.id.refile).setVisible(false);\n  1135→            }\n  1136→\n  1137→            if (messageViewFragment.allHeadersVisible()) {\n  1138→                menu.findItem(R.id.show_headers).setVisible(false);\n  1139→            } else {\n  1140→                menu.findItem(R.id.hide_headers).setVisible(false);\n  1141→            }\n  1142→        }\n  1143→\n  1144→\n  1145→        /*\n  1146→         * Set visibility of menu items related to the message list\n  1147→         */\n  1148→\n  1149→        // Hide both search menu items by default and enable one when appropriate\n  1150→        menu.findItem(R.id.search).setVisible(false);\n  1151→        menu.findItem(R.id.search_remote).setVisible(false);\n  1152→\n  1153→        if (displayMode == DisplayMode.MESSAGE_VIEW || messageListFragment == null ||\n  1154→                !messageListFragment.isInitialized()) {\n  1155→            menu.findItem(R.id.check_mail).setVisible(false);\n  1156→            menu.findItem(R.id.set_sort).setVisible(false);\n  1157→            menu.findItem(R.id.select_all).setVisible(false);\n  1158→            menu.findItem(R.id.send_messages).setVisible(false);\n  1159→            menu.findItem(R.id.expunge).setVisible(false);\n  1160→            menu.findItem(R.id.mark_all_as_read).setVisible(false);\n  1161→            menu.findItem(R.id.show_folder_list).setVisible(false);\n  1162→        } else {\n  1163→            menu.findItem(R.id.set_sort).setVisible(true);\n  1164→            menu.findItem(R.id.select_all).setVisible(true);\n  1165→            menu.findItem(R.id.compose).setVisible(true);\n  1166→            menu.findItem(R.id.mark_all_as_read).setVisible(\n  1167→                    messageListFragment.isMarkAllAsReadSupported());\n  1168→\n  1169→            if (!messageListFragment.isSingleAccountMode()) {\n  1170→                menu.findItem(R.id.expunge).setVisible(false);\n  1171→                menu.findItem(R.id.send_messages).setVisible(false);\n  1172→                menu.findItem(R.id.show_folder_list).setVisible(false);\n  1173→            } else {\n  1174→                menu.findItem(R.id.send_messages).setVisible(messageListFragment.isOutbox());\n  1175→                menu.findItem(R.id.expunge).setVisible(messageListFragment.isRemoteFolder() &&\n  1176→                        messageListFragment.isAccountExpungeCapable());\n  1177→                menu.findItem(R.id.show_folder_list).setVisible(true);\n  1178→            }\n  1179→\n  1180→            menu.findItem(R.id.check_mail).setVisible(messageListFragment.isCheckMailSupported());\n  1181→\n  1182→            // If this is an explicit local search, show the option to search on the server\n  1183→            if (!messageListFragment.isRemoteSearch() &&\n  1184→                    messageListFragment.isRemoteSearchAllowed()) {\n  1185→                menu.findItem(R.id.search_remote).setVisible(true);\n  1186→            } else if (!messageListFragment.isManualSearch()) {\n  1187→                menu.findItem(R.id.search).setVisible(true);\n  1188→            }\n  1189→        }\n  1190→    }\n  1191→\n  1192→    protected void onAccountUnavailable() {\n  1193→        finish();\n  1194→        // TODO inform user about account unavailability using Toast\n  1195→        Accounts.listAccounts(this);\n  1196→    }\n  1197→\n  1198→    public void setActionBarTitle(String title) {\n  1199→        actionBarTitle.setText(title);\n  1200→    }\n  1201→\n  1202→    public void setActionBarSubTitle(String subTitle) {\n  1203→        actionBarSubTitle.setText(subTitle);\n  1204→    }\n  1205→\n  1206→    @Override\n  1207→    public void setMessageListTitle(String title) {\n  1208→        setActionBarTitle(title);\n  1209→    }\n  1210→\n  1211→    @Override\n  1212→    public void setMessageListSubTitle(String subTitle) {\n  1213→        setActionBarSubTitle(subTitle);\n  1214→    }\n  1215→\n  1216→    @Override\n  1217→    public void setMessageListProgress(int progress) {\n  1218→        setProgress(progress);\n  1219→    }\n  1220→\n  1221→    @Override\n  1222→    public void openMessage(MessageReference messageReference) {\n  1223→        Account account = preferences.getAccount(messageReference.getAccountUuid());\n  1224→        String folderServerId = messageReference.getFolderServerId();\n  1225→\n  1226→        if (folderServerId.equals(account.getDraftsFolder())) {\n  1227→            MessageActions.actionEditDraft(this, messageReference);\n  1228→        } else {\n  1229→            messageViewContainer.removeView(messageViewPlaceHolder);\n  1230→\n  1231→            if (messageListFragment != null) {\n  1232→                messageListFragment.setActiveMessage(messageReference);\n  1233→            }\n  1234→\n  1235→            MessageViewFragment fragment = MessageViewFragment.newInstance(messageReference);\n  1236→            FragmentTransaction ft = getSupportFragmentManager().beginTransaction();\n  1237→            ft.replace(R.id.message_view_container, fragment);\n  1238→            messageViewFragment = fragment;\n  1239→            ft.commit();\n  1240→\n  1241→            if (displayMode != DisplayMode.SPLIT_VIEW) {\n  1242→                showMessageView();\n  1243→            }\n  1244→        }\n  1245→    }\n  1246→\n  1247→    @Override\n  1248→    public void onResendMessage(MessageReference messageReference) {\n  1249→        MessageActions.actionEditDraft(this, messageReference);\n  1250→    }\n  1251→\n  1252→    @Override\n  1253→    public void onForward(MessageReference messageReference) {\n  1254→        onForward(messageReference, null);\n  1255→    }\n  1256→\n  1257→    @Override\n  1258→    public void onForward(MessageReference messageReference, Parcelable decryptionResultForReply) {\n  1259→        MessageActions.actionForward(this, messageReference, decryptionResultForReply);\n  1260→    }\n  1261→\n  1262→    @Override\n  1263→    public void onForwardAsAttachment(MessageReference messageReference) {\n  1264→        onForwardAsAttachment(messageReference, null);\n  1265→    }\n  1266→\n  1267→    @Override\n  1268→    public void onForwardAsAttachment(MessageReference messageReference, Parcelable decryptionResultForReply) {\n  1269→        MessageActions.actionForwardAsAttachment(this, messageReference, decryptionResultForReply);\n  1270→    }\n  1271→\n  1272→    @Override\n  1273→    public void onReply(MessageReference messageReference) {\n  1274→        onReply(messageReference, null);\n  1275→    }\n  1276→\n  1277→    @Override\n  1278→    public void onReply(MessageReference messageReference, Parcelable decryptionResultForReply) {\n  1279→        MessageActions.actionReply(this, messageReference, false, decryptionResultForReply);\n  1280→    }\n  1281→\n  1282→    @Override\n  1283→    public void onReplyAll(MessageReference messageReference) {\n  1284→        onReplyAll(messageReference, null);\n  1285→    }\n  1286→\n  1287→    @Override\n  1288→    public void onReplyAll(MessageReference messageReference, Parcelable decryptionResultForReply) {\n  1289→        MessageActions.actionReply(this, messageReference, true, decryptionResultForReply);\n  1290→    }\n  1291→\n  1292→    @Override\n  1293→    public void onCompose(Account account) {\n  1294→        MessageActions.actionCompose(this, account);\n  1295→    }\n  1296→\n  1297→    @Override\n  1298→    public void showMoreFromSameSender(String senderAddress) {\n  1299→        LocalSearch tmpSearch = new LocalSearch(getString(R.string.search_from_format, senderAddress));\n  1300→        tmpSearch.addAccountUuids(search.getAccountUuids());\n  1301→        tmpSearch.and(SearchField.SENDER, senderAddress, Attribute.CONTAINS);\n  1302→\n  1303→        initializeFromLocalSearch(tmpSearch);\n  1304→\n  1305→        MessageListFragment fragment = MessageListFragment.newInstance(tmpSearch, false, false);\n  1306→        addMessageListFragment(fragment, true);\n  1307→    }\n  1308→\n  1309→    @Override\n  1310→    public void onBackStackChanged() {\n  1311→        findFragments();\n  1312→\n  1313→        if (isDrawerEnabled() && !isAdditionalMessageListDisplayed()) {\n  1314→            unlockDrawer();\n  1315→        }\n  1316→\n  1317→        if (displayMode == DisplayMode.SPLIT_VIEW) {\n  1318→            showMessageViewPlaceHolder();\n  1319→        }\n  1320→\n  1321→        configureMenu(menu);\n  1322→    }\n  1323→\n  1324→    @Override\n  1325→    public void onSwipeRightToLeft(MotionEvent e1, MotionEvent e2) {\n  1326→        // Disabled because it interferes with the bezel swipe for the drawer\n  1327→//        if (messageListFragment != null && displayMode != DisplayMode.MESSAGE_VIEW) {\n  1328→//            messageListFragment.onSwipeRightToLeft(e1, e2);\n  1329→//        }\n  1330→    }\n  1331→\n  1332→    @Override\n  1333→    public void onSwipeLeftToRight(MotionEvent e1, MotionEvent e2) {\n  1334→        // Disabled because it interferes with the bezel swipe for the drawer\n  1335→//        if (messageListFragment != null && displayMode != DisplayMode.MESSAGE_VIEW) {\n  1336→//            messageListFragment.onSwipeLeftToRight(e1, e2);\n  1337→//        }\n  1338→    }\n  1339→\n  1340→    private final class StorageListenerImplementation implements StorageManager.StorageListener {\n  1341→        @Override\n  1342→        public void onUnmount(String providerId) {\n  1343→            if (account != null && providerId.equals(account.getLocalStorageProviderId())) {\n  1344→                runOnUiThread(new Runnable() {\n  1345→                    @Override\n  1346→                    public void run() {\n  1347→                        onAccountUnavailable();\n  1348→                    }\n  1349→                });\n  1350→            }\n  1351→        }\n  1352→\n  1353→        @Override\n  1354→        public void onMount(String providerId) {\n  1355→            // no-op\n  1356→        }\n  1357→    }\n  1358→\n  1359→    private void addMessageListFragment(MessageListFragment fragment, boolean addToBackStack) {\n  1360→        FragmentTransaction ft = getSupportFragmentManager().beginTransaction();\n  1361→\n  1362→        ft.replace(R.id.message_list_container, fragment);\n  1363→        if (addToBackStack)\n  1364→            ft.addToBackStack(null);\n  1365→\n  1366→        messageListFragment = fragment;\n  1367→\n  1368→        if (isDrawerEnabled()) {\n  1369→            lockDrawer();\n  1370→        }\n  1371→\n  1372→        int transactionId = ft.commit();\n  1373→        if (transactionId >= 0 && firstBackStackId < 0) {\n  1374→            firstBackStackId = transactionId;\n  1375→        }\n  1376→    }\n  1377→\n  1378→    @Override\n  1379→    public boolean startSearch(Account account, String folderServerId) {\n  1380→        // If this search was started from a MessageList of a single folder, pass along that folder info\n  1381→        // so that we can enable remote search.\n  1382→        if (account != null && folderServerId != null) {\n  1383→            final Bundle appData = new Bundle();\n  1384→            appData.putString(EXTRA_SEARCH_ACCOUNT, account.getUuid());\n  1385→            appData.putString(EXTRA_SEARCH_FOLDER, folderServerId);\n  1386→            startSearch(null, false, appData, false);\n  1387→        } else {\n  1388→            // TODO Handle the case where we're searching from within a search result.\n  1389→            startSearch(null, false, null, false);\n  1390→        }\n  1391→\n  1392→        return true;\n  1393→    }\n  1394→\n  1395→    @Override\n  1396→    public void showThread(Account account, String folderServerId, long threadRootId) {\n  1397→        showMessageViewPlaceHolder();\n  1398→\n  1399→        LocalSearch tmpSearch = new LocalSearch();\n  1400→        tmpSearch.addAccountUuid(account.getUuid());\n  1401→        tmpSearch.and(SearchField.THREAD_ID, String.valueOf(threadRootId), Attribute.EQUALS);\n  1402→\n  1403→        initializeFromLocalSearch(tmpSearch);\n  1404→\n  1405→        MessageListFragment fragment = MessageListFragment.newInstance(tmpSearch, true, false);\n  1406→        addMessageListFragment(fragment, true);\n  1407→    }\n  1408→\n  1409→    private void showMessageViewPlaceHolder() {\n  1410→        removeMessageViewFragment();\n  1411→\n  1412→        // Add placeholder view if necessary\n  1413→        if (messageViewPlaceHolder.getParent() == null) {\n  1414→            messageViewContainer.addView(messageViewPlaceHolder);\n  1415→        }\n  1416→\n  1417→        messageListFragment.setActiveMessage(null);\n  1418→    }\n  1419→\n  1420→    /**\n  1421→     * Remove MessageViewFragment if necessary.\n  1422→     */\n  1423→    private void removeMessageViewFragment() {\n  1424→        if (messageViewFragment != null) {\n  1425→            FragmentTransaction ft = getSupportFragmentManager().beginTransaction();\n  1426→            ft.remove(messageViewFragment);\n  1427→            messageViewFragment = null;\n  1428→            ft.commit();\n  1429→\n  1430→            showDefaultTitleView();\n  1431→        }\n  1432→    }\n  1433→\n  1434→    private void removeMessageListFragment() {\n  1435→        FragmentTransaction ft = getSupportFragmentManager().beginTransaction();\n  1436→        ft.remove(messageListFragment);\n  1437→        messageListFragment = null;\n  1438→        ft.commit();\n  1439→    }\n  1440→\n  1441→    @Override\n  1442→    public void remoteSearchStarted() {\n  1443→        // Remove action button for remote search\n  1444→        configureMenu(menu);\n  1445→    }\n  1446→\n  1447→    @Override\n  1448→    public void goBack() {\n  1449→        FragmentManager fragmentManager = getSupportFragmentManager();\n  1450→        if (displayMode == DisplayMode.MESSAGE_VIEW) {\n  1451→            showMessageList();\n  1452→        } else if (fragmentManager.getBackStackEntryCount() > 0) {\n  1453→            fragmentManager.popBackStack();\n  1454→        } else if (messageListFragment.isManualSearch()) {\n  1455→            finish();\n  1456→        } else if (!singleFolderMode) {\n  1457→            onAccounts();\n  1458→        } else {\n  1459→            onShowFolderList();\n  1460→        }\n  1461→    }\n  1462→\n  1463→    @Override\n  1464→    public void enableActionBarProgress(boolean enable) {\n  1465→        if (menuButtonCheckMail != null && menuButtonCheckMail.isVisible()) {\n  1466→            actionBarProgress.setVisibility(ProgressBar.GONE);\n  1467→            if (enable) {\n  1468→                menuButtonCheckMail\n  1469→                        .setActionView(actionButtonIndeterminateProgress);\n  1470→            } else {\n  1471→                menuButtonCheckMail.setActionView(null);\n  1472→            }\n  1473→        } else {\n  1474→            if (menuButtonCheckMail != null)\n  1475→                menuButtonCheckMail.setActionView(null);\n  1476→            if (enable) {\n  1477→                actionBarProgress.setVisibility(ProgressBar.VISIBLE);\n  1478→            } else {\n  1479→                actionBarProgress.setVisibility(ProgressBar.GONE);\n  1480→            }\n  1481→        }\n  1482→    }\n  1483→\n  1484→    @Override\n  1485→    public void displayMessageSubject(String subject) {\n  1486→        if (displayMode == DisplayMode.MESSAGE_VIEW) {\n  1487→            actionBarSubject.setText(subject);\n  1488→        } else {\n  1489→            actionBarSubject.showSubjectInMessageHeader();\n  1490→        }\n  1491→    }\n  1492→\n  1493→    @Override\n  1494→    public void showNextMessageOrReturn() {\n  1495→        if (K9.messageViewReturnToList() || !showLogicalNextMessage()) {\n  1496→            if (displayMode == DisplayMode.SPLIT_VIEW) {\n  1497→                showMessageViewPlaceHolder();\n  1498→            } else {\n  1499→                showMessageList();\n  1500→            }\n  1501→        }\n  1502→    }\n  1503→\n  1504→    /**\n  1505→     * Shows the next message in the direction the user was displaying messages.\n  1506→     *\n  1507→     * @return {@code true}\n  1508→     */\n  1509→    private boolean showLogicalNextMessage() {\n  1510→        boolean result = false;\n  1511→        if (lastDirection == NEXT) {\n  1512→            result = showNextMessage();\n  1513→        } else if (lastDirection == PREVIOUS) {\n  1514→            result = showPreviousMessage();\n  1515→        }\n  1516→\n  1517→        if (!result) {\n  1518→            result = showNextMessage() || showPreviousMessage();\n  1519→        }\n  1520→\n  1521→        return result;\n  1522→    }\n  1523→\n  1524→    @Override\n  1525→    public void setProgress(boolean enable) {\n  1526→        setProgressBarIndeterminateVisibility(enable);\n  1527→    }\n  1528→\n  1529→    @Override\n  1530→    public void messageHeaderViewAvailable(MessageHeader header) {\n  1531→        actionBarSubject.setMessageHeader(header);\n  1532→    }\n  1533→\n  1534→    private boolean showNextMessage() {\n  1535→        MessageReference ref = messageViewFragment.getMessageReference();\n  1536→        if (ref != null) {\n  1537→            if (messageListFragment.openNext(ref)) {\n  1538→                lastDirection = NEXT;\n  1539→                return true;\n  1540→            }\n  1541→        }\n  1542→        return false;\n  1543→    }\n  1544→\n  1545→    private boolean showPreviousMessage() {\n  1546→        MessageReference ref = messageViewFragment.getMessageReference();\n  1547→        if (ref != null) {\n  1548→            if (messageListFragment.openPrevious(ref)) {\n  1549→                lastDirection = PREVIOUS;\n  1550→                return true;\n  1551→            }\n  1552→        }\n  1553→        return false;\n  1554→    }\n  1555→\n  1556→    private void showMessageList() {\n  1557→        messageListWasDisplayed = true;\n  1558→        displayMode = DisplayMode.MESSAGE_LIST;\n  1559→        viewSwitcher.showFirstView();\n  1560→\n  1561→        messageListFragment.setActiveMessage(null);\n  1562→\n  1563→        if (isDrawerEnabled()) {\n  1564→            if (isAdditionalMessageListDisplayed()) {\n  1565→                lockDrawer();\n  1566→            } else {\n  1567→                unlockDrawer();\n  1568→            }\n  1569→        }\n  1570→\n  1571→        showDefaultTitleView();\n  1572→        configureMenu(menu);\n  1573→    }\n  1574→\n  1575→    private void showMessageView() {\n  1576→        displayMode = DisplayMode.MESSAGE_VIEW;\n  1577→\n  1578→        if (!messageListWasDisplayed) {\n  1579→            viewSwitcher.setAnimateFirstView(false);\n  1580→        }\n  1581→        viewSwitcher.showSecondView();\n  1582→\n  1583→        if (isDrawerEnabled()) {\n  1584→            lockDrawer();\n  1585→        }\n  1586→\n  1587→        showMessageTitleView();\n  1588→        configureMenu(menu);\n  1589→    }\n  1590→\n  1591→    @Override\n  1592→    public void updateMenu() {\n  1593→        invalidateOptionsMenu();\n  1594→    }\n  1595→\n  1596→    @Override\n  1597→    public void disableDeleteAction() {\n  1598→        menu.findItem(R.id.delete).setEnabled(false);\n  1599→    }\n  1600→\n  1601→    private void onToggleTheme() {\n  1602→        if (K9.getK9MessageViewTheme() == K9.Theme.DARK) {\n  1603→            K9.setK9MessageViewThemeSetting(K9.Theme.LIGHT);\n  1604→        } else {\n  1605→            K9.setK9MessageViewThemeSetting(K9.Theme.DARK);\n  1606→        }\n  1607→\n  1608→        new Thread(new Runnable() {\n  1609→            @Override\n  1610→            public void run() {\n  1611→                StorageEditor editor = preferences.getStorage().edit();\n  1612→                K9.save(editor);\n  1613→                editor.commit();\n  1614→            }\n  1615→        }).start();\n  1616→\n  1617→        recreate();\n  1618→    }\n  1619→\n  1620→    private void showDefaultTitleView() {\n  1621→        actionBarMessageView.setVisibility(View.GONE);\n  1622→        actionBarMessageList.setVisibility(View.VISIBLE);\n  1623→\n  1624→        if (messageListFragment != null) {\n  1625→            messageListFragment.updateTitle();\n  1626→        }\n  1627→\n  1628→        actionBarSubject.setMessageHeader(null);\n  1629→    }\n  1630→\n  1631→    private void showMessageTitleView() {\n  1632→        actionBarMessageList.setVisibility(View.GONE);\n  1633→        actionBarMessageView.setVisibility(View.VISIBLE);\n  1634→\n  1635→        if (messageViewFragment != null) {\n  1636→            displayMessageSubject(null);\n  1637→            messageViewFragment.updateTitle();\n  1638→        }\n  1639→    }\n  1640→\n  1641→    @Override\n  1642→    public void onSwitchComplete(int displayedChild) {\n  1643→        if (displayedChild == 0) {\n  1644→            removeMessageViewFragment();\n  1645→        }\n  1646→    }\n  1647→\n  1648→    @Override\n  1649→    public void startIntentSenderForResult(IntentSender intent, int requestCode, Intent fillInIntent,\n  1650→            int flagsMask, int flagsValues, int extraFlags) throws SendIntentException {\n  1651→        requestCode |= REQUEST_MASK_PENDING_INTENT;\n  1652→        super.startIntentSenderForResult(intent, requestCode, fillInIntent, flagsMask, flagsValues, extraFlags);\n  1653→    }\n  1654→\n  1655→    @Override\n  1656→    protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n  1657→        super.onActivityResult(requestCode, resultCode, data);\n  1658→\n  1659→        if ((requestCode & REQUEST_MASK_PENDING_INTENT) == REQUEST_MASK_PENDING_INTENT) {\n  1660→            requestCode ^= REQUEST_MASK_PENDING_INTENT;\n  1661→            if (messageViewFragment != null) {\n  1662→                messageViewFragment.onPendingIntentResult(requestCode, resultCode, data);\n  1663→            }\n  1664→        }\n  1665→    }\n  1666→\n  1667→    private boolean isAdditionalMessageListDisplayed() {\n  1668→        FragmentManager fragmentManager = getSupportFragmentManager();\n  1669→        return fragmentManager.getBackStackEntryCount() > 0;\n  1670→    }\n  1671→\n  1672→    private void lockDrawer() {\n  1673→        drawer.lock();\n  1674→        drawerToggle.setDrawerIndicatorEnabled(false);\n  1675→    }\n  1676→\n  1677→    private void unlockDrawer() {\n  1678→        drawer.unlock();\n  1679→        drawerToggle.setDrawerIndicatorEnabled(true);\n  1680→    }\n  1681→\n  1682→    private void initializeFromLocalSearch(LocalSearch search) {\n  1683→        this.search = search;\n  1684→\n  1685→        if (search.searchAllAccounts()) {\n  1686→            List<Account> accounts = preferences.getAccounts();\n  1687→            singleAccountMode = (accounts.size() == 1);\n  1688→            if (singleAccountMode) {\n  1689→                account = accounts.get(0);\n  1690→            }\n  1691→        } else {\n  1692→            String[] accountUuids = search.getAccountUuids();\n  1693→            singleAccountMode = (accountUuids.length == 1);\n  1694→            if (singleAccountMode) {\n  1695→                account = preferences.getAccount(accountUuids[0]);\n  1696→            }\n  1697→        }\n  1698→\n  1699→        List<String> folderServerIds = search.getFolderServerIds();\n  1700→        singleFolderMode = singleAccountMode && folderServerIds.size() == 1;\n  1701→        if (drawer == null) {\n  1702→            return;\n  1703→        } else if (singleFolderMode) {\n  1704→            drawer.selectFolder(folderServerIds.get(0));\n  1705→        } else if (search.getId().equals(SearchAccount.UNIFIED_INBOX)) {\n  1706→            drawer.selectUnifiedInbox();\n  1707→        } else {\n  1708→            drawer.selectFolder(null);\n  1709→        }\n  1710→\n  1711→        // now we know if we are in single account mode and need a subtitle\n  1712→        actionBarSubTitle.setVisibility((!singleFolderMode) ? View.GONE : View.VISIBLE);\n  1713→    }\n  1714→}\n  1715→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"88bdc1ca-367a-4a32-95c0-62fc4439b647","tool_use_result":{"type":"text","file":{"filePath":"/Users/emmayu/crqbench/projects/thunderbird-android/app/ui/src/main/java/com/fsck/k9/activity/MessageList.java","content":"package com.fsck.k9.activity;\n\n\nimport android.annotation.SuppressLint;\nimport android.app.SearchManager;\nimport android.arch.lifecycle.Observer;\nimport android.arch.lifecycle.ViewModelProvider;\nimport android.arch.lifecycle.ViewModelProviders;\nimport android.content.Context;\nimport android.content.Intent;\nimport android.content.IntentSender;\nimport android.content.IntentSender.SendIntentException;\nimport android.content.res.Configuration;\nimport android.net.Uri;\nimport android.os.Build;\nimport android.os.Bundle;\nimport android.os.Parcelable;\nimport android.support.annotation.Nullable;\nimport android.support.v4.app.FragmentManager;\nimport android.support.v4.app.FragmentManager.OnBackStackChangedListener;\nimport android.support.v4.app.FragmentTransaction;\nimport android.support.v4.widget.DrawerLayout;\nimport android.support.v7.app.ActionBar;\nimport android.support.v7.app.ActionBarDrawerToggle;\nimport android.view.KeyEvent;\nimport android.view.LayoutInflater;\nimport android.view.Menu;\nimport android.view.MenuItem;\nimport android.view.MotionEvent;\nimport android.view.View;\nimport android.view.ViewGroup;\nimport android.view.animation.AnimationUtils;\nimport android.widget.ProgressBar;\nimport android.widget.TextView;\nimport android.widget.Toast;\n\nimport com.fsck.k9.Account;\nimport com.fsck.k9.Account.SortType;\nimport com.fsck.k9.DI;\nimport com.fsck.k9.K9;\nimport com.fsck.k9.K9.SplitViewMode;\nimport com.fsck.k9.Preferences;\nimport com.fsck.k9.activity.compose.MessageActions;\nimport com.fsck.k9.activity.misc.SwipeGestureDetector.OnSwipeGestureListener;\nimport com.fsck.k9.controller.MessageReference;\nimport com.fsck.k9.fragment.MessageListFragment;\nimport com.fsck.k9.fragment.MessageListFragment.MessageListFragmentListener;\nimport com.fsck.k9.helper.Contacts;\nimport com.fsck.k9.helper.ParcelableUtil;\nimport com.fsck.k9.mailstore.Folder;\nimport com.fsck.k9.mailstore.SearchStatusManager;\nimport com.fsck.k9.mailstore.StorageManager;\nimport com.fsck.k9.notification.NotificationChannelManager;\nimport com.fsck.k9.preferences.StorageEditor;\nimport com.fsck.k9.search.LocalSearch;\nimport com.fsck.k9.search.SearchAccount;\nimport com.fsck.k9.search.SearchSpecification;\nimport com.fsck.k9.search.SearchSpecification.Attribute;\nimport com.fsck.k9.search.SearchSpecification.SearchCondition;\nimport com.fsck.k9.search.SearchSpecification.SearchField;\nimport com.fsck.k9.ui.K9Drawer;\nimport com.fsck.k9.ui.R;\nimport com.fsck.k9.ui.messagelist.MessageListViewModel;\nimport com.fsck.k9.ui.messagelist.MessageListViewModelFactory;\nimport com.fsck.k9.ui.messageview.MessageViewFragment;\nimport com.fsck.k9.ui.messageview.MessageViewFragment.MessageViewFragmentListener;\nimport com.fsck.k9.ui.settings.SettingsActivity;\nimport com.fsck.k9.view.MessageHeader;\nimport com.fsck.k9.view.MessageTitleView;\nimport com.fsck.k9.view.ViewSwitcher;\nimport com.fsck.k9.view.ViewSwitcher.OnSwitchCompleteListener;\nimport com.mikepenz.materialdrawer.Drawer.OnDrawerListener;\n\nimport java.util.Collection;\nimport java.util.List;\n\nimport de.cketti.library.changelog.ChangeLog;\nimport timber.log.Timber;\n\n\n/**\n * MessageList is the primary user interface for the program. This Activity\n * shows a list of messages.\n * From this Activity the user can perform all standard message operations.\n */\npublic class MessageList extends K9Activity implements MessageListFragmentListener,\n        MessageViewFragmentListener, OnBackStackChangedListener, OnSwipeGestureListener,\n        OnSwitchCompleteListener {\n\n    private static final String EXTRA_SEARCH = \"search_bytes\";\n    private static final String EXTRA_NO_THREADING = \"no_threading\";\n\n    private static final String ACTION_SHORTCUT = \"shortcut\";\n    private static final String EXTRA_SPECIAL_FOLDER = \"special_folder\";\n\n    private static final String EXTRA_MESSAGE_REFERENCE = \"message_reference\";\n\n    // used for remote search\n    public static final String EXTRA_SEARCH_ACCOUNT = \"com.fsck.k9.search_account\";\n    private static final String EXTRA_SEARCH_FOLDER = \"com.fsck.k9.search_folder\";\n\n    private static final String STATE_DISPLAY_MODE = \"displayMode\";\n    private static final String STATE_MESSAGE_LIST_WAS_DISPLAYED = \"messageListWasDisplayed\";\n    private static final String STATE_FIRST_BACK_STACK_ID = \"firstBackstackId\";\n\n    // Used for navigating to next/previous message\n    private static final int PREVIOUS = 1;\n    private static final int NEXT = 2;\n\n    public static final int REQUEST_MASK_PENDING_INTENT = 1 << 15;\n\n    public static void actionDisplaySearch(Context context, SearchSpecification search,\n            boolean noThreading, boolean newTask) {\n        actionDisplaySearch(context, search, noThreading, newTask, true);\n    }\n\n    public static void actionDisplaySearch(Context context, SearchSpecification search,\n            boolean noThreading, boolean newTask, boolean clearTop) {\n        context.startActivity(\n                intentDisplaySearch(context, search, noThreading, newTask, clearTop));\n    }\n\n    public static Intent intentDisplaySearch(Context context, SearchSpecification search,\n            boolean noThreading, boolean newTask, boolean clearTop) {\n        Intent intent = new Intent(context, MessageList.class);\n        intent.putExtra(EXTRA_SEARCH, ParcelableUtil.marshall(search));\n        intent.putExtra(EXTRA_NO_THREADING, noThreading);\n\n        if (clearTop) {\n            intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\n        }\n        if (newTask) {\n            intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n        }\n\n        return intent;\n    }\n\n    public static Intent shortcutIntent(Context context, String specialFolder) {\n        Intent intent = new Intent(context, MessageList.class);\n        intent.setAction(ACTION_SHORTCUT);\n        intent.putExtra(EXTRA_SPECIAL_FOLDER, specialFolder);\n        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\n        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);\n\n        return intent;\n    }\n\n    public static Intent actionDisplayMessageIntent(Context context,\n            MessageReference messageReference) {\n        Intent intent = new Intent(context, MessageList.class);\n        intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);\n        intent.putExtra(EXTRA_MESSAGE_REFERENCE, messageReference.toIdentityString());\n        return intent;\n    }\n\n\n    private enum DisplayMode {\n        MESSAGE_LIST,\n        MESSAGE_VIEW,\n        SPLIT_VIEW\n    }\n\n\n    protected final SearchStatusManager searchStatusManager = DI.get(SearchStatusManager.class);\n    private StorageManager.StorageListener mStorageListener = new StorageListenerImplementation();\n    private final Preferences preferences = DI.get(Preferences.class);\n    private final NotificationChannelManager channelUtils = DI.get(NotificationChannelManager.class);\n\n    private ActionBar actionBar;\n    private ActionBarDrawerToggle drawerToggle;\n    private K9Drawer drawer;\n    private FragmentTransaction openFolderTransaction;\n    private View actionBarMessageList;\n    private View actionBarMessageView;\n    private MessageTitleView actionBarSubject;\n    private TextView actionBarTitle;\n    private TextView actionBarSubTitle;\n    private Menu menu;\n\n    private ViewGroup messageViewContainer;\n    private View messageViewPlaceHolder;\n\n    private MessageListFragment messageListFragment;\n    private MessageViewFragment messageViewFragment;\n    private int firstBackStackId = -1;\n\n    private Account account;\n    private LocalSearch search;\n    private boolean singleFolderMode;\n    private boolean singleAccountMode;\n\n    private ProgressBar actionBarProgress;\n    private MenuItem menuButtonCheckMail;\n    private View actionButtonIndeterminateProgress;\n    private int lastDirection = (K9.messageViewShowNext()) ? NEXT : PREVIOUS;\n\n    /**\n     * {@code true} if the message list should be displayed as flat list (i.e. no threading)\n     * regardless whether or not message threading was enabled in the settings. This is used for\n     * filtered views, e.g. when only displaying the unread messages in a folder.\n     */\n    private boolean noThreading;\n\n    private DisplayMode displayMode;\n    private MessageReference messageReference;\n\n    /**\n     * {@code true} when the message list was displayed once. This is used in\n     * {@link #onBackPressed()} to decide whether to go from the message view to the message list or\n     * finish the activity.\n     */\n    private boolean messageListWasDisplayed = false;\n    private ViewSwitcher viewSwitcher;\n\n\n    @Override\n    public void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n\n        if (UpgradeDatabases.actionUpgradeDatabases(this, getIntent())) {\n            finish();\n            return;\n        }\n\n        if (useSplitView()) {\n            setContentView(R.layout.split_message_list);\n        } else {\n            setContentView(R.layout.message_list);\n            viewSwitcher = findViewById(R.id.container);\n            viewSwitcher.setFirstInAnimation(AnimationUtils.loadAnimation(this, R.anim.slide_in_left));\n            viewSwitcher.setFirstOutAnimation(AnimationUtils.loadAnimation(this, R.anim.slide_out_right));\n            viewSwitcher.setSecondInAnimation(AnimationUtils.loadAnimation(this, R.anim.slide_in_right));\n            viewSwitcher.setSecondOutAnimation(AnimationUtils.loadAnimation(this, R.anim.slide_out_left));\n            viewSwitcher.setOnSwitchCompleteListener(this);\n        }\n\n        initializeActionBar();\n        initializeDrawer(savedInstanceState);\n\n        // Enable gesture detection for MessageLists\n        setupGestureDetector(this);\n\n        if (!decodeExtras(getIntent())) {\n            return;\n        }\n\n        ViewModelProvider viewModelProvider = ViewModelProviders.of(this, new MessageListViewModelFactory());\n        MessageListViewModel viewModel = viewModelProvider.get(MessageListViewModel.class);\n\n        if (isDrawerEnabled()) {\n            viewModel.getFolders(account).observe(this, new Observer<List<Folder>>() {\n                @Override\n                public void onChanged(@Nullable List<Folder> folders) {\n                    drawer.setUserFolders(folders);\n                }\n            });\n        }\n\n        findFragments();\n        initializeDisplayMode(savedInstanceState);\n        initializeLayout();\n        initializeFragments();\n        displayViews();\n        channelUtils.updateChannels();\n\n        ChangeLog cl = new ChangeLog(this);\n        if (cl.isFirstRun()) {\n            cl.getLogDialog().show();\n        }\n    }\n\n    @Override\n    public void onNewIntent(Intent intent) {\n        super.onNewIntent(intent);\n\n        if (isFinishing()) {\n            return;\n        }\n\n        setIntent(intent);\n\n        if (firstBackStackId >= 0) {\n            getFragmentManager().popBackStackImmediate(firstBackStackId,\n                    FragmentManager.POP_BACK_STACK_INCLUSIVE);\n            firstBackStackId = -1;\n        }\n        removeMessageListFragment();\n        removeMessageViewFragment();\n\n        messageReference = null;\n        search = null;\n\n        if (!decodeExtras(intent)) {\n            return;\n        }\n\n        initializeDisplayMode(null);\n        initializeFragments();\n        displayViews();\n    }\n\n    /**\n     * Get references to existing fragments if the activity was restarted.\n     */\n    private void findFragments() {\n        FragmentManager fragmentManager = getSupportFragmentManager();\n        messageListFragment = (MessageListFragment) fragmentManager.findFragmentById(R.id.message_list_container);\n        messageViewFragment = (MessageViewFragment) fragmentManager.findFragmentById(R.id.message_view_container);\n\n        if (messageListFragment != null) {\n            initializeFromLocalSearch(messageListFragment.getLocalSearch());\n        }\n    }\n\n    /**\n     * Create fragment instances if necessary.\n     *\n     * @see #findFragments()\n     */\n    private void initializeFragments() {\n        FragmentManager fragmentManager = getSupportFragmentManager();\n        fragmentManager.addOnBackStackChangedListener(this);\n\n        boolean hasMessageListFragment = (messageListFragment != null);\n\n        if (!hasMessageListFragment) {\n            FragmentTransaction ft = fragmentManager.beginTransaction();\n            messageListFragment = MessageListFragment.newInstance(search, false,\n                    (K9.isThreadedViewEnabled() && !noThreading));\n            ft.add(R.id.message_list_container, messageListFragment);\n            ft.commit();\n        }\n\n        // Check if the fragment wasn't restarted and has a MessageReference in the arguments. If\n        // so, open the referenced message.\n        if (!hasMessageListFragment && messageViewFragment == null &&\n                messageReference != null) {\n            openMessage(messageReference);\n        }\n    }\n\n    /**\n     * Set the initial display mode (message list, message view, or split view).\n     *\n     * <p><strong>Note:</strong>\n     * This method has to be called after {@link #findFragments()} because the result depends on\n     * the availability of a {@link MessageViewFragment} instance.\n     * </p>\n     *\n     * @param savedInstanceState\n     *         The saved instance state that was passed to the activity as argument to\n     *         {@link #onCreate(Bundle)}. May be {@code null}.\n     */\n    private void initializeDisplayMode(Bundle savedInstanceState) {\n        if (useSplitView()) {\n            displayMode = DisplayMode.SPLIT_VIEW;\n            return;\n        }\n\n        if (savedInstanceState != null) {\n            DisplayMode savedDisplayMode =\n                    (DisplayMode) savedInstanceState.getSerializable(STATE_DISPLAY_MODE);\n            if (savedDisplayMode != DisplayMode.SPLIT_VIEW) {\n                displayMode = savedDisplayMode;\n                return;\n            }\n        }\n\n        if (messageViewFragment != null || messageReference != null) {\n            displayMode = DisplayMode.MESSAGE_VIEW;\n        } else {\n            displayMode = DisplayMode.MESSAGE_LIST;\n        }\n    }\n\n    private boolean useSplitView() {\n        SplitViewMode splitViewMode = K9.getSplitViewMode();\n        int orientation = getResources().getConfiguration().orientation;\n\n        return (splitViewMode == SplitViewMode.ALWAYS ||\n                (splitViewMode == SplitViewMode.WHEN_IN_LANDSCAPE &&\n                orientation == Configuration.ORIENTATION_LANDSCAPE));\n    }\n\n    private void initializeLayout() {\n        messageViewContainer = findViewById(R.id.message_view_container);\n\n        LayoutInflater layoutInflater = getLayoutInflater();\n        messageViewPlaceHolder = layoutInflater.inflate(R.layout.empty_message_view, messageViewContainer, false);\n    }\n\n    private void displayViews() {\n        switch (displayMode) {\n            case MESSAGE_LIST: {\n                showMessageList();\n                break;\n            }\n            case MESSAGE_VIEW: {\n                showMessageView();\n                break;\n            }\n            case SPLIT_VIEW: {\n                messageListWasDisplayed = true;\n                if (messageViewFragment == null) {\n                    showMessageViewPlaceHolder();\n                } else {\n                    MessageReference activeMessage = messageViewFragment.getMessageReference();\n                    if (activeMessage != null) {\n                        messageListFragment.setActiveMessage(activeMessage);\n                    }\n                }\n                break;\n            }\n        }\n    }\n\n    private boolean decodeExtras(Intent intent) {\n        String action = intent.getAction();\n        if (Intent.ACTION_VIEW.equals(action) && intent.getData() != null) {\n            Uri uri = intent.getData();\n            List<String> segmentList = uri.getPathSegments();\n\n            String accountId = segmentList.get(0);\n            Collection<Account> accounts = preferences.getAvailableAccounts();\n            for (Account account : accounts) {\n                if (String.valueOf(account.getAccountNumber()).equals(accountId)) {\n                    String folderServerId = segmentList.get(1);\n                    String messageUid = segmentList.get(2);\n                    messageReference = new MessageReference(account.getUuid(), folderServerId, messageUid, null);\n                    break;\n                }\n            }\n        } else if (ACTION_SHORTCUT.equals(action)) {\n            // Handle shortcut intents\n            String specialFolder = intent.getStringExtra(EXTRA_SPECIAL_FOLDER);\n            if (SearchAccount.UNIFIED_INBOX.equals(specialFolder)) {\n                search = SearchAccount.createUnifiedInboxAccount().getRelatedSearch();\n            } else if (SearchAccount.ALL_MESSAGES.equals(specialFolder)) {\n                search = SearchAccount.createAllMessagesAccount().getRelatedSearch();\n            }\n        } else if (intent.getStringExtra(SearchManager.QUERY) != null) {\n            // check if this intent comes from the system search ( remote )\n            if (Intent.ACTION_SEARCH.equals(intent.getAction())) {\n                //Query was received from Search Dialog\n                String query = intent.getStringExtra(SearchManager.QUERY).trim();\n\n                search = new LocalSearch(getString(R.string.search_results));\n                search.setManualSearch(true);\n                noThreading = true;\n\n                search.or(new SearchCondition(SearchField.SENDER, Attribute.CONTAINS, query));\n                search.or(new SearchCondition(SearchField.SUBJECT, Attribute.CONTAINS, query));\n                search.or(new SearchCondition(SearchField.MESSAGE_CONTENTS, Attribute.CONTAINS, query));\n\n                Bundle appData = intent.getBundleExtra(SearchManager.APP_DATA);\n                if (appData != null) {\n                    search.addAccountUuid(appData.getString(EXTRA_SEARCH_ACCOUNT));\n                    // searches started from a folder list activity will provide an account, but no folder\n                    if (appData.getString(EXTRA_SEARCH_FOLDER) != null) {\n                        search.addAllowedFolder(appData.getString(EXTRA_SEARCH_FOLDER));\n                    }\n                } else {\n                    search.addAccountUuid(LocalSearch.ALL_ACCOUNTS);\n                }\n            }\n        } else {\n            // regular LocalSearch object was passed\n            search = intent.hasExtra(EXTRA_SEARCH) ?\n                    ParcelableUtil.unmarshall(intent.getByteArrayExtra(EXTRA_SEARCH), LocalSearch.CREATOR) : null;\n            noThreading = intent.getBooleanExtra(EXTRA_NO_THREADING, false);\n        }\n\n        if (messageReference == null) {\n            String messageReferenceString = intent.getStringExtra(EXTRA_MESSAGE_REFERENCE);\n            messageReference = MessageReference.parse(messageReferenceString);\n        }\n\n        if (messageReference != null) {\n            search = new LocalSearch();\n            search.addAccountUuid(messageReference.getAccountUuid());\n            String folderServerId = messageReference.getFolderServerId();\n            search.addAllowedFolder(folderServerId);\n        }\n\n        if (search == null) {\n            // We've most likely been started by an old unread widget\n            String accountUuid = intent.getStringExtra(\"account\");\n            String folderServerId = intent.getStringExtra(\"folder\");\n\n            search = new LocalSearch(folderServerId);\n            search.addAccountUuid((accountUuid == null) ? \"invalid\" : accountUuid);\n            if (folderServerId != null) {\n                search.addAllowedFolder(folderServerId);\n            }\n        }\n\n        initializeFromLocalSearch(search);\n\n        if (singleAccountMode && (account == null || !account.isAvailable(this))) {\n            Timber.i(\"not opening MessageList of unavailable account\");\n            onAccountUnavailable();\n            return false;\n        }\n\n        return true;\n    }\n\n    @Override\n    public void onPause() {\n        super.onPause();\n\n        StorageManager.getInstance(getApplication()).removeListener(mStorageListener);\n    }\n\n    @Override\n    public void onResume() {\n        super.onResume();\n\n        if (!(this instanceof Search)) {\n            //necessary b/c no guarantee Search.onStop will be called before MessageList.onResume\n            //when returning from search results\n            searchStatusManager.setActive(false);\n        }\n\n        if (account != null && !account.isAvailable(this)) {\n            onAccountUnavailable();\n            return;\n        }\n        StorageManager.getInstance(getApplication()).addListener(mStorageListener);\n    }\n\n    @Override\n    protected void onStart() {\n        super.onStart();\n        Contacts.clearCache();\n    }\n\n    @Override\n    public void onSaveInstanceState(Bundle outState) {\n        super.onSaveInstanceState(outState);\n\n        outState.putSerializable(STATE_DISPLAY_MODE, displayMode);\n        outState.putBoolean(STATE_MESSAGE_LIST_WAS_DISPLAYED, messageListWasDisplayed);\n        outState.putInt(STATE_FIRST_BACK_STACK_ID, firstBackStackId);\n    }\n\n    @Override\n    public void onRestoreInstanceState(Bundle savedInstanceState) {\n        super.onRestoreInstanceState(savedInstanceState);\n\n        messageListWasDisplayed = savedInstanceState.getBoolean(STATE_MESSAGE_LIST_WAS_DISPLAYED);\n        firstBackStackId = savedInstanceState.getInt(STATE_FIRST_BACK_STACK_ID);\n    }\n\n    private void initializeActionBar() {\n        actionBar = getSupportActionBar();\n\n        actionBar.setDisplayShowCustomEnabled(true);\n        actionBar.setCustomView(R.layout.actionbar_custom);\n\n        View customView = actionBar.getCustomView();\n        actionBarMessageList = customView.findViewById(R.id.actionbar_message_list);\n        actionBarMessageView = customView.findViewById(R.id.actionbar_message_view);\n        actionBarSubject = customView.findViewById(R.id.message_title_view);\n        actionBarTitle = customView.findViewById(R.id.actionbar_title_first);\n        actionBarSubTitle = customView.findViewById(R.id.actionbar_title_sub);\n        actionBarProgress = customView.findViewById(R.id.actionbar_progress);\n        actionButtonIndeterminateProgress = getActionButtonIndeterminateProgress();\n\n        actionBar.setDisplayHomeAsUpEnabled(true);\n    }\n\n    private void initializeDrawer(Bundle savedInstanceState) {\n        if (!isDrawerEnabled()) {\n            return;\n        }\n\n        drawer = new K9Drawer(this, savedInstanceState);\n\n        DrawerLayout drawerLayout = drawer.getLayout();\n        drawerToggle = new ActionBarDrawerToggle(\n                this, drawerLayout, null,\n                R.string.navigation_drawer_open, R.string.navigation_drawer_close\n        );\n        drawerLayout.addDrawerListener(drawerToggle);\n        drawerToggle.syncState();\n    }\n\n    public OnDrawerListener createOnDrawerListener() {\n        return new OnDrawerListener() {\n            @Override\n            public void onDrawerClosed(View drawerView) {\n                if (openFolderTransaction != null) {\n                    openFolderTransaction.commit();\n                    openFolderTransaction = null;\n                }\n            }\n\n            @Override\n            public void onDrawerOpened(View drawerView) {\n                // Do nothing\n            }\n\n            @Override\n            public void onDrawerSlide(View drawerView, float slideOffset) {\n                // Do nothing\n            }\n        };\n    }\n\n    public void openFolder(String folderName) {\n        LocalSearch search = new LocalSearch(folderName);\n        search.addAccountUuid(account.getUuid());\n        search.addAllowedFolder(folderName);\n\n        performSearch(search);\n    }\n\n    public void openUnifiedInbox() {\n        drawer.selectUnifiedInbox();\n        performSearch(SearchAccount.createUnifiedInboxAccount().getRelatedSearch());\n    }\n\n    private void performSearch(LocalSearch search) {\n        initializeFromLocalSearch(search);\n\n        FragmentManager fragmentManager = getSupportFragmentManager();\n        openFolderTransaction = fragmentManager.beginTransaction();\n        messageListFragment = MessageListFragment.newInstance(search, false, K9.isThreadedViewEnabled());\n        openFolderTransaction.replace(R.id.message_list_container, messageListFragment);\n    }\n\n    protected boolean isDrawerEnabled() {\n        return true;\n    }\n\n    @SuppressLint(\"InflateParams\")\n    private View getActionButtonIndeterminateProgress() {\n        return getLayoutInflater().inflate(R.layout.actionbar_indeterminate_progress_actionview, null);\n    }\n\n    @Override\n    public boolean dispatchKeyEvent(KeyEvent event) {\n        boolean ret = false;\n        if (KeyEvent.ACTION_DOWN == event.getAction()) {\n            ret = onCustomKeyDown(event.getKeyCode(), event);\n        }\n        if (!ret) {\n            ret = super.dispatchKeyEvent(event);\n        }\n        return ret;\n    }\n\n    @Override\n    public void onBackPressed() {\n        if (displayMode == DisplayMode.MESSAGE_VIEW && messageListWasDisplayed) {\n            showMessageList();\n        } else {\n            super.onBackPressed();\n        }\n    }\n\n    /**\n     * Handle hotkeys\n     *\n     * <p>\n     * This method is called by {@link #dispatchKeyEvent(KeyEvent)} before any view had the chance\n     * to consume this key event.\n     * </p>\n     *\n     * @param keyCode\n     *         The value in {@code event.getKeyCode()}.\n     * @param event\n     *         Description of the key event.\n     *\n     * @return {@code true} if this event was consumed.\n     */\n    public boolean onCustomKeyDown(final int keyCode, final KeyEvent event) {\n        switch (keyCode) {\n            case KeyEvent.KEYCODE_VOLUME_UP: {\n                if (messageViewFragment != null && displayMode != DisplayMode.MESSAGE_LIST &&\n                        K9.useVolumeKeysForNavigationEnabled()) {\n                    showPreviousMessage();\n                    return true;\n                } else if (displayMode != DisplayMode.MESSAGE_VIEW &&\n                        K9.useVolumeKeysForListNavigationEnabled()) {\n                    messageListFragment.onMoveUp();\n                    return true;\n                }\n\n                break;\n            }\n            case KeyEvent.KEYCODE_VOLUME_DOWN: {\n                if (messageViewFragment != null && displayMode != DisplayMode.MESSAGE_LIST &&\n                        K9.useVolumeKeysForNavigationEnabled()) {\n                    showNextMessage();\n                    return true;\n                } else if (displayMode != DisplayMode.MESSAGE_VIEW &&\n                        K9.useVolumeKeysForListNavigationEnabled()) {\n                    messageListFragment.onMoveDown();\n                    return true;\n                }\n\n                break;\n            }\n            case KeyEvent.KEYCODE_C: {\n                messageListFragment.onCompose();\n                return true;\n            }\n            case KeyEvent.KEYCODE_Q: {\n                if (messageListFragment != null && messageListFragment.isSingleAccountMode()) {\n                    onShowFolderList();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_O: {\n                messageListFragment.onCycleSort();\n                return true;\n            }\n            case KeyEvent.KEYCODE_I: {\n                messageListFragment.onReverseSort();\n                return true;\n            }\n            case KeyEvent.KEYCODE_DEL:\n            case KeyEvent.KEYCODE_D: {\n                if (displayMode == DisplayMode.MESSAGE_LIST) {\n                    messageListFragment.onDelete();\n                } else if (messageViewFragment != null) {\n                    messageViewFragment.onDelete();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_S: {\n                messageListFragment.toggleMessageSelect();\n                return true;\n            }\n            case KeyEvent.KEYCODE_G: {\n                if (displayMode == DisplayMode.MESSAGE_LIST) {\n                    messageListFragment.onToggleFlagged();\n                } else if (messageViewFragment != null) {\n                    messageViewFragment.onToggleFlagged();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_M: {\n                if (displayMode == DisplayMode.MESSAGE_LIST) {\n                    messageListFragment.onMove();\n                } else if (messageViewFragment != null) {\n                    messageViewFragment.onMove();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_V: {\n                if (displayMode == DisplayMode.MESSAGE_LIST) {\n                    messageListFragment.onArchive();\n                } else if (messageViewFragment != null) {\n                    messageViewFragment.onArchive();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_Y: {\n                if (displayMode == DisplayMode.MESSAGE_LIST) {\n                    messageListFragment.onCopy();\n                } else if (messageViewFragment != null) {\n                    messageViewFragment.onCopy();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_Z: {\n                if (displayMode == DisplayMode.MESSAGE_LIST) {\n                    messageListFragment.onToggleRead();\n                } else if (messageViewFragment != null) {\n                    messageViewFragment.onToggleRead();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_F: {\n                if (messageViewFragment != null) {\n                    messageViewFragment.onForward();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_A: {\n                if (messageViewFragment != null) {\n                    messageViewFragment.onReplyAll();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_R: {\n                if (messageViewFragment != null) {\n                    messageViewFragment.onReply();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_J:\n            case KeyEvent.KEYCODE_P: {\n                if (messageViewFragment != null) {\n                    showPreviousMessage();\n                }\n                return true;\n            }\n            case KeyEvent.KEYCODE_N:\n            case KeyEvent.KEYCODE_K: {\n                if (messageViewFragment != null) {\n                    showNextMessage();\n                }\n                return true;\n            }\n            /* FIXME\n            case KeyEvent.KEYCODE_Z: {\n                messageViewFragment.zoom(event);\n                return true;\n            }*/\n            case KeyEvent.KEYCODE_H: {\n                Toast toast;\n                if (displayMode == DisplayMode.MESSAGE_LIST) {\n                    toast = Toast.makeText(this, R.string.message_list_help_key, Toast.LENGTH_LONG);\n                } else {\n                    toast = Toast.makeText(this, R.string.message_view_help_key, Toast.LENGTH_LONG);\n                }\n                toast.show();\n                return true;\n            }\n            case KeyEvent.KEYCODE_DPAD_LEFT: {\n                if (messageViewFragment != null && displayMode == DisplayMode.MESSAGE_VIEW) {\n                    return showPreviousMessage();\n                }\n                return false;\n            }\n            case KeyEvent.KEYCODE_DPAD_RIGHT: {\n                if (messageViewFragment != null && displayMode == DisplayMode.MESSAGE_VIEW) {\n                    return showNextMessage();\n                }\n                return false;\n            }\n\n        }\n\n        return false;\n    }\n\n    @Override\n    public boolean onKeyUp(int keyCode, KeyEvent event) {\n        // Swallow these events too to avoid the audible notification of a volume change\n        if (K9.useVolumeKeysForListNavigationEnabled()) {\n            if ((keyCode == KeyEvent.KEYCODE_VOLUME_UP) || (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN)) {\n                Timber.v(\"Swallowed key up.\");\n                return true;\n            }\n        }\n        return super.onKeyUp(keyCode, event);\n    }\n\n    private void onAccounts() {\n        Accounts.listAccounts(this);\n        finish();\n    }\n\n    private void onShowFolderList() {\n        FolderList.actionHandleAccount(this, account);\n        finish();\n    }\n\n    private void onEditSettings() {\n        SettingsActivity.launch(this);\n    }\n\n    @Override\n    public boolean onSearchRequested() {\n        return messageListFragment.onSearchRequested();\n    }\n\n    @Override\n    public boolean onOptionsItemSelected(MenuItem item) {\n        int id = item.getItemId();\n        if (id == android.R.id.home) {\n            if (displayMode != DisplayMode.MESSAGE_VIEW && !isAdditionalMessageListDisplayed()) {\n                if (isDrawerEnabled()) {\n                    if (drawer.isOpen()) {\n                        drawer.close();\n                    } else {\n                        drawer.open();\n                    }\n                } else {\n                    finish();\n                }\n            } else {\n                goBack();\n            }\n            return true;\n        } else if (id == R.id.compose) {\n            messageListFragment.onCompose();\n            return true;\n        } else if (id == R.id.toggle_message_view_theme) {\n            onToggleTheme();\n            return true;\n        } else if (id == R.id.check_mail) {     // MessageList\n            messageListFragment.checkMail();\n            return true;\n        } else if (id == R.id.set_sort_date) {\n            messageListFragment.changeSort(SortType.SORT_DATE);\n            return true;\n        } else if (id == R.id.set_sort_arrival) {\n            messageListFragment.changeSort(SortType.SORT_ARRIVAL);\n            return true;\n        } else if (id == R.id.set_sort_subject) {\n            messageListFragment.changeSort(SortType.SORT_SUBJECT);\n            return true;\n        } else if (id == R.id.set_sort_sender) {\n            messageListFragment.changeSort(SortType.SORT_SENDER);\n            return true;\n        } else if (id == R.id.set_sort_flag) {\n            messageListFragment.changeSort(SortType.SORT_FLAGGED);\n            return true;\n        } else if (id == R.id.set_sort_unread) {\n            messageListFragment.changeSort(SortType.SORT_UNREAD);\n            return true;\n        } else if (id == R.id.set_sort_attach) {\n            messageListFragment.changeSort(SortType.SORT_ATTACHMENT);\n            return true;\n        } else if (id == R.id.select_all) {\n            messageListFragment.selectAll();\n            return true;\n        } else if (id == R.id.settings) {\n            onEditSettings();\n            return true;\n        } else if (id == R.id.search) {\n            messageListFragment.onSearchRequested();\n            return true;\n        } else if (id == R.id.search_remote) {\n            messageListFragment.onRemoteSearch();\n            return true;\n        } else if (id == R.id.mark_all_as_read) {\n            messageListFragment.confirmMarkAllAsRead();\n            return true;\n        } else if (id == R.id.show_folder_list) {\n            onShowFolderList();\n            return true;\n        } else if (id == R.id.next_message) {   // MessageView\n            showNextMessage();\n            return true;\n        } else if (id == R.id.previous_message) {\n            showPreviousMessage();\n            return true;\n        } else if (id == R.id.delete) {\n            messageViewFragment.onDelete();\n            return true;\n        } else if (id == R.id.reply) {\n            messageViewFragment.onReply();\n            return true;\n        } else if (id == R.id.reply_all) {\n            messageViewFragment.onReplyAll();\n            return true;\n        } else if (id == R.id.forward) {\n            messageViewFragment.onForward();\n            return true;\n        } else if (id == R.id.forward_as_attachment) {\n            messageViewFragment.onForwardAsAttachment();\n            return true;\n        } else if (id == R.id.share) {\n            messageViewFragment.onSendAlternate();\n            return true;\n        } else if (id == R.id.toggle_unread) {\n            messageViewFragment.onToggleRead();\n            return true;\n        } else if (id == R.id.archive || id == R.id.refile_archive) {\n            messageViewFragment.onArchive();\n            return true;\n        } else if (id == R.id.spam || id == R.id.refile_spam) {\n            messageViewFragment.onSpam();\n            return true;\n        } else if (id == R.id.move || id == R.id.refile_move) {\n            messageViewFragment.onMove();\n            return true;\n        } else if (id == R.id.copy || id == R.id.refile_copy) {\n            messageViewFragment.onCopy();\n            return true;\n        } else if (id == R.id.select_text) {\n            messageViewFragment.onSelectText();\n            return true;\n        } else if (id == R.id.show_headers || id == R.id.hide_headers) {\n            messageViewFragment.onToggleAllHeadersView();\n            updateMenu();\n            return true;\n        }\n\n        if (!singleFolderMode) {\n            // None of the options after this point are \"safe\" for search results\n            //TODO: This is not true for \"unread\" and \"starred\" searches in regular folders\n            return false;\n        }\n\n        if (id == R.id.send_messages) {\n            messageListFragment.onSendPendingMessages();\n            return true;\n        } else if (id == R.id.expunge) {\n            messageListFragment.onExpunge();\n            return true;\n        } else {\n            return super.onOptionsItemSelected(item);\n        }\n    }\n\n    @Override\n    public boolean onCreateOptionsMenu(Menu menu) {\n        getMenuInflater().inflate(R.menu.message_list_option, menu);\n        this.menu = menu;\n        menuButtonCheckMail = menu.findItem(R.id.check_mail);\n        return true;\n    }\n\n    @Override\n    public boolean onPrepareOptionsMenu(Menu menu) {\n        super.onPrepareOptionsMenu(menu);\n        configureMenu(menu);\n        return true;\n    }\n\n    /**\n     * Hide menu items not appropriate for the current context.\n     *\n     * <p><strong>Note:</strong>\n     * Please adjust the comments in {@code res/menu/message_list_option.xml} if you change the\n     * visibility of a menu item in this method.\n     * </p>\n     *\n     * @param menu\n     *         The {@link Menu} instance that should be modified. May be {@code null}; in that case\n     *         the method does nothing and immediately returns.\n     */\n    private void configureMenu(Menu menu) {\n        if (menu == null) {\n            return;\n        }\n\n        /*\n         * Set visibility of menu items related to the message view\n         */\n\n        if (displayMode == DisplayMode.MESSAGE_LIST\n                || messageViewFragment == null\n                || !messageViewFragment.isInitialized()) {\n            menu.findItem(R.id.next_message).setVisible(false);\n            menu.findItem(R.id.previous_message).setVisible(false);\n            menu.findItem(R.id.single_message_options).setVisible(false);\n            menu.findItem(R.id.delete).setVisible(false);\n            menu.findItem(R.id.compose).setVisible(false);\n            menu.findItem(R.id.archive).setVisible(false);\n            menu.findItem(R.id.move).setVisible(false);\n            menu.findItem(R.id.copy).setVisible(false);\n            menu.findItem(R.id.spam).setVisible(false);\n            menu.findItem(R.id.refile).setVisible(false);\n            menu.findItem(R.id.toggle_unread).setVisible(false);\n            menu.findItem(R.id.select_text).setVisible(false);\n            menu.findItem(R.id.toggle_message_view_theme).setVisible(false);\n            menu.findItem(R.id.show_headers).setVisible(false);\n            menu.findItem(R.id.hide_headers).setVisible(false);\n        } else {\n            // hide prev/next buttons in split mode\n            if (displayMode != DisplayMode.MESSAGE_VIEW) {\n                menu.findItem(R.id.next_message).setVisible(false);\n                menu.findItem(R.id.previous_message).setVisible(false);\n            } else {\n                MessageReference ref = messageViewFragment.getMessageReference();\n                boolean initialized = (messageListFragment != null &&\n                        messageListFragment.isLoadFinished());\n                boolean canDoPrev = (initialized && !messageListFragment.isFirst(ref));\n                boolean canDoNext = (initialized && !messageListFragment.isLast(ref));\n\n                MenuItem prev = menu.findItem(R.id.previous_message);\n                prev.setEnabled(canDoPrev);\n                prev.getIcon().setAlpha(canDoPrev ? 255 : 127);\n\n                MenuItem next = menu.findItem(R.id.next_message);\n                next.setEnabled(canDoNext);\n                next.getIcon().setAlpha(canDoNext ? 255 : 127);\n            }\n\n            MenuItem toggleTheme = menu.findItem(R.id.toggle_message_view_theme);\n            if (K9.useFixedMessageViewTheme()) {\n                toggleTheme.setVisible(false);\n            } else {\n                // Set title of menu item to switch to dark/light theme\n                if (K9.getK9MessageViewTheme() == K9.Theme.DARK) {\n                    toggleTheme.setTitle(R.string.message_view_theme_action_light);\n                } else {\n                    toggleTheme.setTitle(R.string.message_view_theme_action_dark);\n                }\n                toggleTheme.setVisible(true);\n            }\n\n            // Set title of menu item to toggle the read state of the currently displayed message\n            if (messageViewFragment.isMessageRead()) {\n                menu.findItem(R.id.toggle_unread).setTitle(R.string.mark_as_unread_action);\n            } else {\n                menu.findItem(R.id.toggle_unread).setTitle(R.string.mark_as_read_action);\n            }\n\n            // Jellybean has built-in long press selection support\n            menu.findItem(R.id.select_text).setVisible(Build.VERSION.SDK_INT < 16);\n\n            menu.findItem(R.id.delete).setVisible(K9.isMessageViewDeleteActionVisible());\n\n            /*\n             * Set visibility of copy, move, archive, spam in action bar and refile submenu\n             */\n            if (messageViewFragment.isCopyCapable()) {\n                menu.findItem(R.id.copy).setVisible(K9.isMessageViewCopyActionVisible());\n                menu.findItem(R.id.refile_copy).setVisible(true);\n            } else {\n                menu.findItem(R.id.copy).setVisible(false);\n                menu.findItem(R.id.refile_copy).setVisible(false);\n            }\n\n            if (messageViewFragment.isMoveCapable()) {\n                boolean canMessageBeArchived = messageViewFragment.canMessageBeArchived();\n                boolean canMessageBeMovedToSpam = messageViewFragment.canMessageBeMovedToSpam();\n\n                menu.findItem(R.id.move).setVisible(K9.isMessageViewMoveActionVisible());\n                menu.findItem(R.id.archive).setVisible(canMessageBeArchived &&\n                        K9.isMessageViewArchiveActionVisible());\n                menu.findItem(R.id.spam).setVisible(canMessageBeMovedToSpam &&\n                        K9.isMessageViewSpamActionVisible());\n\n                menu.findItem(R.id.refile_move).setVisible(true);\n                menu.findItem(R.id.refile_archive).setVisible(canMessageBeArchived);\n                menu.findItem(R.id.refile_spam).setVisible(canMessageBeMovedToSpam);\n            } else {\n                menu.findItem(R.id.move).setVisible(false);\n                menu.findItem(R.id.archive).setVisible(false);\n                menu.findItem(R.id.spam).setVisible(false);\n\n                menu.findItem(R.id.refile).setVisible(false);\n            }\n\n            if (messageViewFragment.allHeadersVisible()) {\n                menu.findItem(R.id.show_headers).setVisible(false);\n            } else {\n                menu.findItem(R.id.hide_headers).setVisible(false);\n            }\n        }\n\n\n        /*\n         * Set visibility of menu items related to the message list\n         */\n\n        // Hide both search menu items by default and enable one when appropriate\n        menu.findItem(R.id.search).setVisible(false);\n        menu.findItem(R.id.search_remote).setVisible(false);\n\n        if (displayMode == DisplayMode.MESSAGE_VIEW || messageListFragment == null ||\n                !messageListFragment.isInitialized()) {\n            menu.findItem(R.id.check_mail).setVisible(false);\n            menu.findItem(R.id.set_sort).setVisible(false);\n            menu.findItem(R.id.select_all).setVisible(false);\n            menu.findItem(R.id.send_messages).setVisible(false);\n            menu.findItem(R.id.expunge).setVisible(false);\n            menu.findItem(R.id.mark_all_as_read).setVisible(false);\n            menu.findItem(R.id.show_folder_list).setVisible(false);\n        } else {\n            menu.findItem(R.id.set_sort).setVisible(true);\n            menu.findItem(R.id.select_all).setVisible(true);\n            menu.findItem(R.id.compose).setVisible(true);\n            menu.findItem(R.id.mark_all_as_read).setVisible(\n                    messageListFragment.isMarkAllAsReadSupported());\n\n            if (!messageListFragment.isSingleAccountMode()) {\n                menu.findItem(R.id.expunge).setVisible(false);\n                menu.findItem(R.id.send_messages).setVisible(false);\n                menu.findItem(R.id.show_folder_list).setVisible(false);\n            } else {\n                menu.findItem(R.id.send_messages).setVisible(messageListFragment.isOutbox());\n                menu.findItem(R.id.expunge).setVisible(messageListFragment.isRemoteFolder() &&\n                        messageListFragment.isAccountExpungeCapable());\n                menu.findItem(R.id.show_folder_list).setVisible(true);\n            }\n\n            menu.findItem(R.id.check_mail).setVisible(messageListFragment.isCheckMailSupported());\n\n            // If this is an explicit local search, show the option to search on the server\n            if (!messageListFragment.isRemoteSearch() &&\n                    messageListFragment.isRemoteSearchAllowed()) {\n                menu.findItem(R.id.search_remote).setVisible(true);\n            } else if (!messageListFragment.isManualSearch()) {\n                menu.findItem(R.id.search).setVisible(true);\n            }\n        }\n    }\n\n    protected void onAccountUnavailable() {\n        finish();\n        // TODO inform user about account unavailability using Toast\n        Accounts.listAccounts(this);\n    }\n\n    public void setActionBarTitle(String title) {\n        actionBarTitle.setText(title);\n    }\n\n    public void setActionBarSubTitle(String subTitle) {\n        actionBarSubTitle.setText(subTitle);\n    }\n\n    @Override\n    public void setMessageListTitle(String title) {\n        setActionBarTitle(title);\n    }\n\n    @Override\n    public void setMessageListSubTitle(String subTitle) {\n        setActionBarSubTitle(subTitle);\n    }\n\n    @Override\n    public void setMessageListProgress(int progress) {\n        setProgress(progress);\n    }\n\n    @Override\n    public void openMessage(MessageReference messageReference) {\n        Account account = preferences.getAccount(messageReference.getAccountUuid());\n        String folderServerId = messageReference.getFolderServerId();\n\n        if (folderServerId.equals(account.getDraftsFolder())) {\n            MessageActions.actionEditDraft(this, messageReference);\n        } else {\n            messageViewContainer.removeView(messageViewPlaceHolder);\n\n            if (messageListFragment != null) {\n                messageListFragment.setActiveMessage(messageReference);\n            }\n\n            MessageViewFragment fragment = MessageViewFragment.newInstance(messageReference);\n            FragmentTransaction ft = getSupportFragmentManager().beginTransaction();\n            ft.replace(R.id.message_view_container, fragment);\n            messageViewFragment = fragment;\n            ft.commit();\n\n            if (displayMode != DisplayMode.SPLIT_VIEW) {\n                showMessageView();\n            }\n        }\n    }\n\n    @Override\n    public void onResendMessage(MessageReference messageReference) {\n        MessageActions.actionEditDraft(this, messageReference);\n    }\n\n    @Override\n    public void onForward(MessageReference messageReference) {\n        onForward(messageReference, null);\n    }\n\n    @Override\n    public void onForward(MessageReference messageReference, Parcelable decryptionResultForReply) {\n        MessageActions.actionForward(this, messageReference, decryptionResultForReply);\n    }\n\n    @Override\n    public void onForwardAsAttachment(MessageReference messageReference) {\n        onForwardAsAttachment(messageReference, null);\n    }\n\n    @Override\n    public void onForwardAsAttachment(MessageReference messageReference, Parcelable decryptionResultForReply) {\n        MessageActions.actionForwardAsAttachment(this, messageReference, decryptionResultForReply);\n    }\n\n    @Override\n    public void onReply(MessageReference messageReference) {\n        onReply(messageReference, null);\n    }\n\n    @Override\n    public void onReply(MessageReference messageReference, Parcelable decryptionResultForReply) {\n        MessageActions.actionReply(this, messageReference, false, decryptionResultForReply);\n    }\n\n    @Override\n    public void onReplyAll(MessageReference messageReference) {\n        onReplyAll(messageReference, null);\n    }\n\n    @Override\n    public void onReplyAll(MessageReference messageReference, Parcelable decryptionResultForReply) {\n        MessageActions.actionReply(this, messageReference, true, decryptionResultForReply);\n    }\n\n    @Override\n    public void onCompose(Account account) {\n        MessageActions.actionCompose(this, account);\n    }\n\n    @Override\n    public void showMoreFromSameSender(String senderAddress) {\n        LocalSearch tmpSearch = new LocalSearch(getString(R.string.search_from_format, senderAddress));\n        tmpSearch.addAccountUuids(search.getAccountUuids());\n        tmpSearch.and(SearchField.SENDER, senderAddress, Attribute.CONTAINS);\n\n        initializeFromLocalSearch(tmpSearch);\n\n        MessageListFragment fragment = MessageListFragment.newInstance(tmpSearch, false, false);\n        addMessageListFragment(fragment, true);\n    }\n\n    @Override\n    public void onBackStackChanged() {\n        findFragments();\n\n        if (isDrawerEnabled() && !isAdditionalMessageListDisplayed()) {\n            unlockDrawer();\n        }\n\n        if (displayMode == DisplayMode.SPLIT_VIEW) {\n            showMessageViewPlaceHolder();\n        }\n\n        configureMenu(menu);\n    }\n\n    @Override\n    public void onSwipeRightToLeft(MotionEvent e1, MotionEvent e2) {\n        // Disabled because it interferes with the bezel swipe for the drawer\n//        if (messageListFragment != null && displayMode != DisplayMode.MESSAGE_VIEW) {\n//            messageListFragment.onSwipeRightToLeft(e1, e2);\n//        }\n    }\n\n    @Override\n    public void onSwipeLeftToRight(MotionEvent e1, MotionEvent e2) {\n        // Disabled because it interferes with the bezel swipe for the drawer\n//        if (messageListFragment != null && displayMode != DisplayMode.MESSAGE_VIEW) {\n//            messageListFragment.onSwipeLeftToRight(e1, e2);\n//        }\n    }\n\n    private final class StorageListenerImplementation implements StorageManager.StorageListener {\n        @Override\n        public void onUnmount(String providerId) {\n            if (account != null && providerId.equals(account.getLocalStorageProviderId())) {\n                runOnUiThread(new Runnable() {\n                    @Override\n                    public void run() {\n                        onAccountUnavailable();\n                    }\n                });\n            }\n        }\n\n        @Override\n        public void onMount(String providerId) {\n            // no-op\n        }\n    }\n\n    private void addMessageListFragment(MessageListFragment fragment, boolean addToBackStack) {\n        FragmentTransaction ft = getSupportFragmentManager().beginTransaction();\n\n        ft.replace(R.id.message_list_container, fragment);\n        if (addToBackStack)\n            ft.addToBackStack(null);\n\n        messageListFragment = fragment;\n\n        if (isDrawerEnabled()) {\n            lockDrawer();\n        }\n\n        int transactionId = ft.commit();\n        if (transactionId >= 0 && firstBackStackId < 0) {\n            firstBackStackId = transactionId;\n        }\n    }\n\n    @Override\n    public boolean startSearch(Account account, String folderServerId) {\n        // If this search was started from a MessageList of a single folder, pass along that folder info\n        // so that we can enable remote search.\n        if (account != null && folderServerId != null) {\n            final Bundle appData = new Bundle();\n            appData.putString(EXTRA_SEARCH_ACCOUNT, account.getUuid());\n            appData.putString(EXTRA_SEARCH_FOLDER, folderServerId);\n            startSearch(null, false, appData, false);\n        } else {\n            // TODO Handle the case where we're searching from within a search result.\n            startSearch(null, false, null, false);\n        }\n\n        return true;\n    }\n\n    @Override\n    public void showThread(Account account, String folderServerId, long threadRootId) {\n        showMessageViewPlaceHolder();\n\n        LocalSearch tmpSearch = new LocalSearch();\n        tmpSearch.addAccountUuid(account.getUuid());\n        tmpSearch.and(SearchField.THREAD_ID, String.valueOf(threadRootId), Attribute.EQUALS);\n\n        initializeFromLocalSearch(tmpSearch);\n\n        MessageListFragment fragment = MessageListFragment.newInstance(tmpSearch, true, false);\n        addMessageListFragment(fragment, true);\n    }\n\n    private void showMessageViewPlaceHolder() {\n        removeMessageViewFragment();\n\n        // Add placeholder view if necessary\n        if (messageViewPlaceHolder.getParent() == null) {\n            messageViewContainer.addView(messageViewPlaceHolder);\n        }\n\n        messageListFragment.setActiveMessage(null);\n    }\n\n    /**\n     * Remove MessageViewFragment if necessary.\n     */\n    private void removeMessageViewFragment() {\n        if (messageViewFragment != null) {\n            FragmentTransaction ft = getSupportFragmentManager().beginTransaction();\n            ft.remove(messageViewFragment);\n            messageViewFragment = null;\n            ft.commit();\n\n            showDefaultTitleView();\n        }\n    }\n\n    private void removeMessageListFragment() {\n        FragmentTransaction ft = getSupportFragmentManager().beginTransaction();\n        ft.remove(messageListFragment);\n        messageListFragment = null;\n        ft.commit();\n    }\n\n    @Override\n    public void remoteSearchStarted() {\n        // Remove action button for remote search\n        configureMenu(menu);\n    }\n\n    @Override\n    public void goBack() {\n        FragmentManager fragmentManager = getSupportFragmentManager();\n        if (displayMode == DisplayMode.MESSAGE_VIEW) {\n            showMessageList();\n        } else if (fragmentManager.getBackStackEntryCount() > 0) {\n            fragmentManager.popBackStack();\n        } else if (messageListFragment.isManualSearch()) {\n            finish();\n        } else if (!singleFolderMode) {\n            onAccounts();\n        } else {\n            onShowFolderList();\n        }\n    }\n\n    @Override\n    public void enableActionBarProgress(boolean enable) {\n        if (menuButtonCheckMail != null && menuButtonCheckMail.isVisible()) {\n            actionBarProgress.setVisibility(ProgressBar.GONE);\n            if (enable) {\n                menuButtonCheckMail\n                        .setActionView(actionButtonIndeterminateProgress);\n            } else {\n                menuButtonCheckMail.setActionView(null);\n            }\n        } else {\n            if (menuButtonCheckMail != null)\n                menuButtonCheckMail.setActionView(null);\n            if (enable) {\n                actionBarProgress.setVisibility(ProgressBar.VISIBLE);\n            } else {\n                actionBarProgress.setVisibility(ProgressBar.GONE);\n            }\n        }\n    }\n\n    @Override\n    public void displayMessageSubject(String subject) {\n        if (displayMode == DisplayMode.MESSAGE_VIEW) {\n            actionBarSubject.setText(subject);\n        } else {\n            actionBarSubject.showSubjectInMessageHeader();\n        }\n    }\n\n    @Override\n    public void showNextMessageOrReturn() {\n        if (K9.messageViewReturnToList() || !showLogicalNextMessage()) {\n            if (displayMode == DisplayMode.SPLIT_VIEW) {\n                showMessageViewPlaceHolder();\n            } else {\n                showMessageList();\n            }\n        }\n    }\n\n    /**\n     * Shows the next message in the direction the user was displaying messages.\n     *\n     * @return {@code true}\n     */\n    private boolean showLogicalNextMessage() {\n        boolean result = false;\n        if (lastDirection == NEXT) {\n            result = showNextMessage();\n        } else if (lastDirection == PREVIOUS) {\n            result = showPreviousMessage();\n        }\n\n        if (!result) {\n            result = showNextMessage() || showPreviousMessage();\n        }\n\n        return result;\n    }\n\n    @Override\n    public void setProgress(boolean enable) {\n        setProgressBarIndeterminateVisibility(enable);\n    }\n\n    @Override\n    public void messageHeaderViewAvailable(MessageHeader header) {\n        actionBarSubject.setMessageHeader(header);\n    }\n\n    private boolean showNextMessage() {\n        MessageReference ref = messageViewFragment.getMessageReference();\n        if (ref != null) {\n            if (messageListFragment.openNext(ref)) {\n                lastDirection = NEXT;\n                return true;\n            }\n        }\n        return false;\n    }\n\n    private boolean showPreviousMessage() {\n        MessageReference ref = messageViewFragment.getMessageReference();\n        if (ref != null) {\n            if (messageListFragment.openPrevious(ref)) {\n                lastDirection = PREVIOUS;\n                return true;\n            }\n        }\n        return false;\n    }\n\n    private void showMessageList() {\n        messageListWasDisplayed = true;\n        displayMode = DisplayMode.MESSAGE_LIST;\n        viewSwitcher.showFirstView();\n\n        messageListFragment.setActiveMessage(null);\n\n        if (isDrawerEnabled()) {\n            if (isAdditionalMessageListDisplayed()) {\n                lockDrawer();\n            } else {\n                unlockDrawer();\n            }\n        }\n\n        showDefaultTitleView();\n        configureMenu(menu);\n    }\n\n    private void showMessageView() {\n        displayMode = DisplayMode.MESSAGE_VIEW;\n\n        if (!messageListWasDisplayed) {\n            viewSwitcher.setAnimateFirstView(false);\n        }\n        viewSwitcher.showSecondView();\n\n        if (isDrawerEnabled()) {\n            lockDrawer();\n        }\n\n        showMessageTitleView();\n        configureMenu(menu);\n    }\n\n    @Override\n    public void updateMenu() {\n        invalidateOptionsMenu();\n    }\n\n    @Override\n    public void disableDeleteAction() {\n        menu.findItem(R.id.delete).setEnabled(false);\n    }\n\n    private void onToggleTheme() {\n        if (K9.getK9MessageViewTheme() == K9.Theme.DARK) {\n            K9.setK9MessageViewThemeSetting(K9.Theme.LIGHT);\n        } else {\n            K9.setK9MessageViewThemeSetting(K9.Theme.DARK);\n        }\n\n        new Thread(new Runnable() {\n            @Override\n            public void run() {\n                StorageEditor editor = preferences.getStorage().edit();\n                K9.save(editor);\n                editor.commit();\n            }\n        }).start();\n\n        recreate();\n    }\n\n    private void showDefaultTitleView() {\n        actionBarMessageView.setVisibility(View.GONE);\n        actionBarMessageList.setVisibility(View.VISIBLE);\n\n        if (messageListFragment != null) {\n            messageListFragment.updateTitle();\n        }\n\n        actionBarSubject.setMessageHeader(null);\n    }\n\n    private void showMessageTitleView() {\n        actionBarMessageList.setVisibility(View.GONE);\n        actionBarMessageView.setVisibility(View.VISIBLE);\n\n        if (messageViewFragment != null) {\n            displayMessageSubject(null);\n            messageViewFragment.updateTitle();\n        }\n    }\n\n    @Override\n    public void onSwitchComplete(int displayedChild) {\n        if (displayedChild == 0) {\n            removeMessageViewFragment();\n        }\n    }\n\n    @Override\n    public void startIntentSenderForResult(IntentSender intent, int requestCode, Intent fillInIntent,\n            int flagsMask, int flagsValues, int extraFlags) throws SendIntentException {\n        requestCode |= REQUEST_MASK_PENDING_INTENT;\n        super.startIntentSenderForResult(intent, requestCode, fillInIntent, flagsMask, flagsValues, extraFlags);\n    }\n\n    @Override\n    protected void onActivityResult(int requestCode, int resultCode, Intent data) {\n        super.onActivityResult(requestCode, resultCode, data);\n\n        if ((requestCode & REQUEST_MASK_PENDING_INTENT) == REQUEST_MASK_PENDING_INTENT) {\n            requestCode ^= REQUEST_MASK_PENDING_INTENT;\n            if (messageViewFragment != null) {\n                messageViewFragment.onPendingIntentResult(requestCode, resultCode, data);\n            }\n        }\n    }\n\n    private boolean isAdditionalMessageListDisplayed() {\n        FragmentManager fragmentManager = getSupportFragmentManager();\n        return fragmentManager.getBackStackEntryCount() > 0;\n    }\n\n    private void lockDrawer() {\n        drawer.lock();\n        drawerToggle.setDrawerIndicatorEnabled(false);\n    }\n\n    private void unlockDrawer() {\n        drawer.unlock();\n        drawerToggle.setDrawerIndicatorEnabled(true);\n    }\n\n    private void initializeFromLocalSearch(LocalSearch search) {\n        this.search = search;\n\n        if (search.searchAllAccounts()) {\n            List<Account> accounts = preferences.getAccounts();\n            singleAccountMode = (accounts.size() == 1);\n            if (singleAccountMode) {\n                account = accounts.get(0);\n            }\n        } else {\n            String[] accountUuids = search.getAccountUuids();\n            singleAccountMode = (accountUuids.length == 1);\n            if (singleAccountMode) {\n                account = preferences.getAccount(accountUuids[0]);\n            }\n        }\n\n        List<String> folderServerIds = search.getFolderServerIds();\n        singleFolderMode = singleAccountMode && folderServerIds.size() == 1;\n        if (drawer == null) {\n            return;\n        } else if (singleFolderMode) {\n            drawer.selectFolder(folderServerIds.get(0));\n        } else if (search.getId().equals(SearchAccount.UNIFIED_INBOX)) {\n            drawer.selectUnifiedInbox();\n        } else {\n            drawer.selectFolder(null);\n        }\n\n        // now we know if we are in single account mode and need a subtitle\n        actionBarSubTitle.setVisibility((!singleFolderMode) ? View.GONE : View.VISIBLE);\n    }\n}\n","numLines":1715,"startLine":1,"totalLines":1715}}}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_0194fx5PchHKWy6vkAtmpXse","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me find the `initializeFromLocalSearch` method and examine the code at the end of it:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":22931,"cache_read_input_tokens":8944,"cache_creation":{"ephemeral_5m_input_tokens":22931,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"a2144d7d-cbe0-4a1c-bfbd-697a6b2acb04"}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_0194fx5PchHKWy6vkAtmpXse","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Lu5WGhpjh78eqVdSeSwyat","name":"Read","input":{"file_path":"/Users/emmayu/crqbench/projects/thunderbird-android/app/ui/src/main/java/com/fsck/k9/activity/MessageList.java","offset":1680,"limit":35}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":22931,"cache_read_input_tokens":8944,"cache_creation":{"ephemeral_5m_input_tokens":22931,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"6c984efa-38fe-4540-b732-96fac629c712"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Lu5WGhpjh78eqVdSeSwyat","type":"tool_result","content":"  1680→    }\n  1681→\n  1682→    private void initializeFromLocalSearch(LocalSearch search) {\n  1683→        this.search = search;\n  1684→\n  1685→        if (search.searchAllAccounts()) {\n  1686→            List<Account> accounts = preferences.getAccounts();\n  1687→            singleAccountMode = (accounts.size() == 1);\n  1688→            if (singleAccountMode) {\n  1689→                account = accounts.get(0);\n  1690→            }\n  1691→        } else {\n  1692→            String[] accountUuids = search.getAccountUuids();\n  1693→            singleAccountMode = (accountUuids.length == 1);\n  1694→            if (singleAccountMode) {\n  1695→                account = preferences.getAccount(accountUuids[0]);\n  1696→            }\n  1697→        }\n  1698→\n  1699→        List<String> folderServerIds = search.getFolderServerIds();\n  1700→        singleFolderMode = singleAccountMode && folderServerIds.size() == 1;\n  1701→        if (drawer == null) {\n  1702→            return;\n  1703→        } else if (singleFolderMode) {\n  1704→            drawer.selectFolder(folderServerIds.get(0));\n  1705→        } else if (search.getId().equals(SearchAccount.UNIFIED_INBOX)) {\n  1706→            drawer.selectUnifiedInbox();\n  1707→        } else {\n  1708→            drawer.selectFolder(null);\n  1709→        }\n  1710→\n  1711→        // now we know if we are in single account mode and need a subtitle\n  1712→        actionBarSubTitle.setVisibility((!singleFolderMode) ? View.GONE : View.VISIBLE);\n  1713→    }\n  1714→}\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"3a972dd6-0b15-421f-aad2-6ecede988cb7","tool_use_result":{"type":"text","file":{"filePath":"/Users/emmayu/crqbench/projects/thunderbird-android/app/ui/src/main/java/com/fsck/k9/activity/MessageList.java","content":"    }\n\n    private void initializeFromLocalSearch(LocalSearch search) {\n        this.search = search;\n\n        if (search.searchAllAccounts()) {\n            List<Account> accounts = preferences.getAccounts();\n            singleAccountMode = (accounts.size() == 1);\n            if (singleAccountMode) {\n                account = accounts.get(0);\n            }\n        } else {\n            String[] accountUuids = search.getAccountUuids();\n            singleAccountMode = (accountUuids.length == 1);\n            if (singleAccountMode) {\n                account = preferences.getAccount(accountUuids[0]);\n            }\n        }\n\n        List<String> folderServerIds = search.getFolderServerIds();\n        singleFolderMode = singleAccountMode && folderServerIds.size() == 1;\n        if (drawer == null) {\n            return;\n        } else if (singleFolderMode) {\n            drawer.selectFolder(folderServerIds.get(0));\n        } else if (search.getId().equals(SearchAccount.UNIFIED_INBOX)) {\n            drawer.selectUnifiedInbox();\n        } else {\n            drawer.selectFolder(null);\n        }\n\n        // now we know if we are in single account mode and need a subtitle\n        actionBarSubTitle.setVisibility((!singleFolderMode) ? View.GONE : View.VISIBLE);\n    }\n}","numLines":35,"startLine":1680,"totalLines":1715}}}
{"type":"assistant","message":{"model":"claude-opus-4-20250514","id":"msg_01H8VeiJquUergKCRMRK46YA","type":"message","role":"assistant","content":[{"type":"text","text":"Yes, the code at the end of `initializeFromLocalSearch` does depend on the `drawer` variable. Looking at lines 1701-1709:\n\n```java\nif (drawer == null) {\n    return;\n} else if (singleFolderMode) {\n    drawer.selectFolder(folderServerIds.get(0));\n} else if (search.getId().equals(SearchAccount.UNIFIED_INBOX)) {\n    drawer.selectUnifiedInbox();\n} else {\n    drawer.selectFolder(null);\n}\n```\n\nThe code explicitly checks if `drawer` is null on line 1701. If it is null, the method returns early and skips the drawer-related operations. If `drawer` is not null, it performs various operations on the drawer based on the search mode:\n\n1. In single folder mode, it selects a specific folder\n2. In unified inbox mode, it selects the unified inbox\n3. Otherwise, it clears the folder selection\n\nThis is related to the git commit message \"Don't try to operate on an uninitialized drawer\" (commit 7f8894c8f9), which suggests there was a bug where the drawer might not have been initialized when this code was executed."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":740,"cache_read_input_tokens":31875,"cache_creation":{"ephemeral_5m_input_tokens":740,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard","inference_geo":"not_available"},"context_management":null},"parent_tool_use_id":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","uuid":"c074a5b3-35a1-4fee-a3ef-5bf803fc0fb9"}
{"type":"result","subtype":"success","is_error":false,"duration_ms":29364,"duration_api_ms":27951,"num_turns":5,"result":"Yes, the code at the end of `initializeFromLocalSearch` does depend on the `drawer` variable. Looking at lines 1701-1709:\n\n```java\nif (drawer == null) {\n    return;\n} else if (singleFolderMode) {\n    drawer.selectFolder(folderServerIds.get(0));\n} else if (search.getId().equals(SearchAccount.UNIFIED_INBOX)) {\n    drawer.selectUnifiedInbox();\n} else {\n    drawer.selectFolder(null);\n}\n```\n\nThe code explicitly checks if `drawer` is null on line 1701. If it is null, the method returns early and skips the drawer-related operations. If `drawer` is not null, it performs various operations on the drawer based on the search mode:\n\n1. In single folder mode, it selects a specific folder\n2. In unified inbox mode, it selects the unified inbox\n3. Otherwise, it clears the folder selection\n\nThis is related to the git commit message \"Don't try to operate on an uninitialized drawer\" (commit 7f8894c8f9), which suggests there was a bug where the drawer might not have been initialized when this code was executed.","stop_reason":null,"session_id":"a3014417-ac1f-4d8f-9728-589140381065","total_cost_usd":0.76114325,"usage":{"input_tokens":27,"cache_creation_input_tokens":32615,"cache_read_input_tokens":57218,"output_tokens":819,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":32615}},"modelUsage":{"claude-opus-4-20250514":{"inputTokens":27,"outputTokens":819,"cacheReadInputTokens":57218,"cacheCreationInputTokens":32615,"webSearchRequests":0,"costUSD":0.75918825,"contextWindow":200000,"maxOutputTokens":32000},"claude-haiku-4-5-20251001":{"inputTokens":1505,"outputTokens":90,"cacheReadInputTokens":0,"cacheCreationInputTokens":0,"webSearchRequests":0,"costUSD":0.001955,"contextWindow":200000,"maxOutputTokens":64000}},"permission_denials":[],"uuid":"dc3ea1d8-7459-44de-899e-a0bd3c31b2a4"}
